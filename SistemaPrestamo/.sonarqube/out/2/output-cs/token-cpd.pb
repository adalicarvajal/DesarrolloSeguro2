‡;
jC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Servives\SecurityHeadersService.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Servives 
;  
public 
class "
SecurityHeadersService #
{ 
private 
readonly 

Dictionary 
<  
string  &
,& '
string( .
>. /
_scriptHashes0 =
=> ?
new@ C
(C D
)D E
;E F
private		 
readonly		 

Dictionary		 
<		  
string		  &
,		& '
string		( .
>		. /
_styleHashes		0 <
=		= >
new		? B
(		B C
)		C D
;		D E
public 

string 
ComputeHash 
( 
string $
content% ,
), -
{ 
using 
var 
sha256 
= 
SHA256 !
.! "
Create" (
(( )
)) *
;* +
var 
hash 
= 
sha256 
. 
ComputeHash %
(% &
Encoding& .
.. /
UTF8/ 3
.3 4
GetBytes4 <
(< =
content= D
)D E
)E F
;F G
return 
Convert 
. 
ToBase64String %
(% &
hash& *
)* +
;+ ,
} 
public 

string 
GetScriptHash 
(  
string  &
script' -
)- .
{ 
if 

( 
_scriptHashes 
. 
TryGetValue %
(% &
script& ,
,, -
out. 1
var2 5
hash6 :
): ;
); <
{ 	
return 
hash 
; 
} 	
hash 
= 
ComputeHash 
( 
script !
)! "
;" #
_scriptHashes 
[ 
script 
] 
= 
hash  $
;$ %
return 
hash 
; 
} 
public 

string 
GetStyleHash 
( 
string %
style& +
)+ ,
{ 
if   

(   
_styleHashes   
.   
TryGetValue   $
(  $ %
style  % *
,  * +
out  , /
var  0 3
hash  4 8
)  8 9
)  9 :
{!! 	
return"" 
hash"" 
;"" 
}## 	
hash%% 
=%% 
ComputeHash%% 
(%% 
style%%  
)%%  !
;%%! "
_styleHashes&& 
[&& 
style&& 
]&& 
=&& 
hash&& "
;&&" #
return'' 
hash'' 
;'' 
}(( 
public** 

string** 
GetCSPHeader** 
(** 
string** %
nonce**& +
)**+ ,
{++ 
var,, 
trustedScriptHashes,, 
=,,  !
string,," (
.,,( )
Join,,) -
(,,- .
$str,,. 1
,,,1 2
_scriptHashes,,3 @
.,,@ A
Values,,A G
.,,G H
Select,,H N
(,,N O
h,,O P
=>,,Q S
$",,T V
$str,,V ^
{,,^ _
h,,_ `
},,` a
$str,,a b
",,b c
),,c d
),,d e
;,,e f
var-- 
trustedStyleHashes-- 
=--  
string--! '
.--' (
Join--( ,
(--, -
$str--- 0
,--0 1
_styleHashes--2 >
.--> ?
Values--? E
.--E F
Select--F L
(--L M
h--M N
=>--O Q
$"--R T
$str--T \
{--\ ]
h--] ^
}--^ _
$str--_ `
"--` a
)--a b
)--b c
;--c d
var00 
trustedDomains00 
=00 
new00  
[00  !
]00! "
{11 	
$str22 #
,22# $
$str33 $
,33$ %
$str44 $
,44$ %
$str55 %
,55% &
$str66 (
}77 	
;77	 

var99 #
trustedWebsocketDomains99 #
=99$ %
new99& )
[99) *
]99* +
{:: 	
$str;; !
,;;! "
$str<< "
,<<" #
$str== "
,==" #
$str>> #
}?? 	
;??	 

varAA 
	scriptSrcAA 
=AA 
newAA 
[AA 
]AA 
{BB 	
$strCC 
,CC 
$"DD 
$strDD 
{DD 
nonceDD 
}DD 
$strDD 
"DD 
,DD 
trustedScriptHashesEE 
,EE  
$strFF 
}GG 	
.GG	 

WhereGG
 
(GG 
sGG 
=>GG 
!GG 
stringGG 
.GG 
IsNullOrEmptyGG *
(GG* +
sGG+ ,
)GG, -
)GG- .
;GG. /
varII 

connectSrcII 
=II 
newII 
[II 
]II 
{JJ 	
$strKK 
,KK 
stringLL 
.LL 
JoinLL 
(LL 
$strLL 
,LL 
trustedDomainsLL +
)LL+ ,
,LL, -
stringMM 
.MM 
JoinMM 
(MM 
$strMM 
,MM #
trustedWebsocketDomainsMM 4
)MM4 5
}NN 	
;NN	 

returnPP 
newPP 
StringBuilderPP  
(PP  !
)PP! "
.QQ 
AppendQQ 
(QQ 
$strQQ *
)QQ* +
.RR 
AppendRR 
(RR 
$"RR 
$strRR !
{RR! "
stringRR" (
.RR( )
JoinRR) -
(RR- .
$strRR. 1
,RR1 2
	scriptSrcRR3 <
)RR< =
}RR= >
$strRR> @
"RR@ A
)RRA B
.SS 
AppendSS 
(SS 
$"SS 
$strSS .
{SS. /
nonceSS/ 4
}SS4 5
$strSS5 7
{SS7 8
trustedStyleHashesSS8 J
}SSJ K
$strSSK M
"SSM N
)SSN O
.TT 
AppendTT 
(TT 
$strTT ,
)TT, -
.UU 
AppendUU 
(UU 
$strUU -
)UU- .
.VV 
AppendVV 
(VV 
$"VV 
$strVV "
{VV" #
stringVV# )
.VV) *
JoinVV* .
(VV. /
$strVV/ 2
,VV2 3

connectSrcVV4 >
)VV> ?
}VV? @
$strVV@ B
"VVB C
)VVC D
.WW 
AppendWW 
(WW 
$strWW .
)WW. /
.XX 
AppendXX 
(XX 
$strXX *
)XX* +
.YY 
AppendYY 
(YY 
$strYY '
)YY' (
.ZZ 
AppendZZ 
(ZZ 
$strZZ )
)ZZ) *
.[[ 
Append[[ 
([[ 
$str[[ 0
)[[0 1
.\\ 
ToString\\ 
(\\ 
)\\ 
;\\ 
}]] 
}^^ ∞
dC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Servives\AuditoriaService.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Servives 
{ 
public 

class 
AuditoriaService !
{ 
private 
readonly 
AuditoriaData &
_auditoriaData' 5
;5 6
public

 
AuditoriaService

 
(

  
AuditoriaData

  -
auditoriaData

. ;
)

; <
{ 	
_auditoriaData 
= 
auditoriaData *
;* +
} 	
public 
async 
Task 
RegistrarLog &
(& '
string' -
usuario. 5
,5 6
string7 =
accion> D
,D E
stringF L
detallesM U
)U V
{ 	
var 
log 
= 
new 
	Auditoria #
{ 
Usuario 
= 
usuario !
,! "
Accion 
= 
accion 
,  
Fecha 
= 
DateTime  
.  !
UtcNow! '
,' (
Detalles 
= 
detalles #
} 
; 
await 
_auditoriaData  
.  !
Insertar! )
() *
log* -
)- .
;. /
} 	
} 
} âm
RC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Program.cs
var

 
builder

 
=

 
WebApplication

 
.

 
CreateBuilder

 *
(

* +
args

+ /
)

/ 0
;

0 1
	DotNetEnv 	
.	 

Env
 
. 
Load 
( 
) 
; 
builder 
. 
Services 
. #
AddControllersWithViews (
(( )
)) *
;* +
builder 
. 
Services 
. 
	Configure 
< 
ConnectionStrings ,
>, -
(- .
builder. 5
.5 6
Configuration6 C
.C D

GetSectionD N
(N O
$strO b
)b c
)c d
;d e
builder 
. 
Services 
. 
AddSingleton 
< 
EmailService *
>* +
(+ ,
), -
;- .
builder 
. 
Services 
. 
	Configure 
< 
SmtpSettings '
>' (
(( )
builder) 0
.0 1
Configuration1 >
.> ?

GetSection? I
(I J
$strJ P
)P Q
)Q R
;R S
builder 
. 
Services 
. 
AddSingleton 
< 

MonedaData (
>( )
() *
)* +
;+ ,
builder 
. 
Services 
. 
AddSingleton 
< 
ClienteData )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
AddSingleton 
< 
PrestamoData *
>* +
(+ ,
), -
;- .
builder 
. 
Services 
. 
AddSingleton 
< 
ResumenData )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
AddSingleton 
< 
UsuarioData )
>) *
(* +
)+ ,
;, -
builder 
. 
Services 
. 
	AddScoped 
< 
ResumenClienteData -
>- .
(. /
)/ 0
;0 1
builder 
. 
Services 
. 
AddSingleton 
< 
AuditoriaData +
>+ ,
(, -
)- .
;. /
builder 
. 
Services 
. 
	AddScoped 
< 
AuditoriaService +
>+ ,
(, -
)- .
;. /
builder 
. 
Services 
. 
AddSingleton 
< 

CuentaData (
>( )
() *
)* +
;+ ,
builder 
. 
Services 
. 
AddSingleton 
< "
SecurityHeadersService 4
>4 5
(5 6
)6 7
;7 8
builder!! 
.!! 
Services!! 
.!! 
AddCors!! 
(!! 
options!!  
=>!!! #
{"" 
options## 
.## 
AddDefaultPolicy## 
(## 
policy## #
=>##$ &
{$$ 
policy%% 
.%% 
WithOrigins%% 
(%% 
$str&& #
,&&# $
$str'' $
)(( 	
.)) 	
WithMethods))	 
()) 
$str)) 
,)) 
$str)) "
,))" #
$str))$ -
)))- .
.** 	
WithHeaders**	 
(** 
$str** #
,**# $
$str**% 4
,**4 5
$str**6 H
)**H I
.++ 	
AllowCredentials++	 
(++ 
)++ 
;++ 
},, 
),, 
;,, 
}-- 
)-- 
;-- 
builder00 
.00 
Services00 
.00 
AddAuthentication00 "
(00" #
options00# *
=>00+ -
{11 
options22 
.22 
DefaultScheme22 
=22 (
CookieAuthenticationDefaults22 8
.228 9 
AuthenticationScheme229 M
;22M N
options33 
.33 "
DefaultChallengeScheme33 "
=33# $(
CookieAuthenticationDefaults33% A
.33A B 
AuthenticationScheme33B V
;33V W
options44 
.44 %
DefaultAuthenticateScheme44 %
=44& '(
CookieAuthenticationDefaults44( D
.44D E 
AuthenticationScheme44E Y
;44Y Z
}55 
)55 
.77 
	AddCookie77 

(77
 (
CookieAuthenticationDefaults77 '
.77' ( 
AuthenticationScheme77( <
,77< =
options77> E
=>77F H
{88 
options99 
.99 
	LoginPath99 
=99 
$str99  
;99  !
options:: 
.:: 
AccessDeniedPath:: 
=:: 
$str:: '
;::' (
options;; 
.;; 
ExpireTimeSpan;; 
=;; 
TimeSpan;; %
.;;% &
FromMinutes;;& 1
(;;1 2
$num;;2 4
);;4 5
;;;5 6
options<< 
.<< 
Cookie<< 
.<< 
Name<< 
=<< 
$str<< (
;<<( )
options== 
.== 
SlidingExpiration== 
=== 
true==  $
;==$ %
}>> 
)>> 
.@@ 
AddJwtBearer@@ 
(@@ 
JwtBearerDefaults@@ 
.@@   
AuthenticationScheme@@  4
,@@4 5
options@@6 =
=>@@> @
{AA 
optionsBB 
.BB 
	SaveTokenBB 
=BB 
trueBB 
;BB 
optionsCC 
.CC  
RequireHttpsMetadataCC  
=CC! "
falseCC# (
;CC( )
optionsDD 
.DD %
TokenValidationParametersDD %
=DD& '
newDD( +%
TokenValidationParametersDD, E
{EE 
ValidateIssuerFF 
=FF 
trueFF 
,FF 
ValidateAudienceGG 
=GG 
trueGG 
,GG  
ValidateLifetimeHH 
=HH 
trueHH 
,HH  $
ValidateIssuerSigningKeyII  
=II! "
trueII# '
,II' (
ValidIssuerJJ 
=JJ 
builderJJ 
.JJ 
ConfigurationJJ +
[JJ+ ,
$strJJ, 8
]JJ8 9
,JJ9 :
ValidAudienceKK 
=KK 
builderKK 
.KK  
ConfigurationKK  -
[KK- .
$strKK. :
]KK: ;
,KK; <
IssuerSigningKeyLL 
=LL 
newLL  
SymmetricSecurityKeyLL 3
(LL3 4
EncodingLL4 <
.LL< =
UTF8LL= A
.LLA B
GetBytesLLB J
(LLJ K
builderLLK R
.LLR S
ConfigurationLLS `
[LL` a
$strLLa j
]LLj k
!LLk l
)LLl m
)LLm n
}MM 
;MM 
optionsNN 
.NN 
EventsNN 
=NN 
newNN 
JwtBearerEventsNN (
{OO 
OnMessageReceivedPP 
=PP 
contextPP #
=>PP$ &
{PP' (
contextQQ 
.QQ 
TokenQQ 
=QQ 
contextQQ #
.QQ# $
RequestQQ$ +
.QQ+ ,
CookiesQQ, 3
[QQ3 4
$strQQ4 B
]QQB C
;QQC D
returnRR 
TaskRR 
.RR 
CompletedTaskRR %
;RR% &
}SS 	
}TT 
;TT 
}UU 
)UU 
;UU 
builderWW 
.WW 
ServicesWW 
.WW 
AddAuthorizationWW !
(WW! "
)WW" #
;WW# $
builderZZ 
.ZZ 
ServicesZZ 
.ZZ %
AddDistributedMemoryCacheZZ *
(ZZ* +
)ZZ+ ,
;ZZ, -
builder[[ 
.[[ 
Services[[ 
.[[ 

AddSession[[ 
([[ 
options[[ #
=>[[$ &
{\\ 
options]] 
.]] 
IdleTimeout]] 
=]] 
TimeSpan]] "
.]]" #
FromMinutes]]# .
(]]. /
$num]]/ 1
)]]1 2
;]]2 3
options^^ 
.^^ 
Cookie^^ 
.^^ 
HttpOnly^^ 
=^^ 
true^^ "
;^^" #
options__ 
.__ 
Cookie__ 
.__ 
IsEssential__ 
=__  
true__! %
;__% &
}`` 
)`` 
;`` 
varbb 
appbb 
=bb 	
builderbb
 
.bb 
Buildbb 
(bb 
)bb 
;bb 
ifee 
(ee 
!ee 
appee 
.ee 	
Environmentee	 
.ee 
IsDevelopmentee "
(ee" #
)ee# $
)ee$ %
{ff 
appgg 
.gg 
UseExceptionHandlergg 
(gg 
$strgg )
)gg) *
;gg* +
apphh 
.hh 
UseHstshh 
(hh 
)hh 
;hh 
}ii 
varll 
securityHeadersll 
=ll 
appll 
.ll 
Servicesll "
.ll" #
GetRequiredServicell# 5
<ll5 6"
SecurityHeadersServicell6 L
>llL M
(llM N
)llN O
;llO P
appnn 
.nn 
Usenn 
(nn 
asyncnn 
(nn 
contextnn 
,nn 
nextnn 
)nn 
=>nn  
{oo 
varqq 
scriptNonceqq 
=qq 
Convertqq 
.qq 
ToBase64Stringqq ,
(qq, -!
RandomNumberGeneratorqq- B
.qqB C
GetBytesqqC K
(qqK L
$numqqL N
)qqN O
)qqO P
;qqP Q
contextrr 
.rr 
Itemsrr 
[rr 
$strrr 
]rr  
=rr! "
scriptNoncerr# .
;rr. /
contextuu 
.uu 
Responseuu 
.uu 
Headersuu 
.uu 
Adduu  
(uu  !
$struu! 2
,uu2 3
$struu4 @
)uu@ A
;uuA B
contextxx 
.xx 
Responsexx 
.xx 
Headersxx 
.xx 
Addxx  
(xx  !
$stryy !
,yy! "
securityHeaderszz 
.zz 
GetCSPHeaderzz $
(zz$ %
scriptNoncezz% 0
)zz0 1
){{ 
;{{ 
context~~ 
.~~ 
Response~~ 
.~~ 
Headers~~ 
.~~ 
Add~~  
(~~  !
$str~~! 9
,~~9 :
$str~~; D
)~~D E
;~~E F
context 
. 
Response 
. 
Headers 
. 
Add  
(  !
$str! 2
,2 3
$str4 U
)U V
;V W
context
ÄÄ 
.
ÄÄ 
Response
ÄÄ 
.
ÄÄ 
Headers
ÄÄ 
.
ÄÄ 
Add
ÄÄ  
(
ÄÄ  !
$str
ÄÄ! 5
,
ÄÄ5 6
$str
ÅÅ w
)
ÅÅw x
;
ÅÅx y
context
ÇÇ 
.
ÇÇ 
Response
ÇÇ 
.
ÇÇ 
Headers
ÇÇ 
.
ÇÇ 
Add
ÇÇ  
(
ÇÇ  !
$str
ÇÇ! ?
,
ÇÇ? @
$str
ÇÇA O
)
ÇÇO P
;
ÇÇP Q
context
ÉÉ 
.
ÉÉ 
Response
ÉÉ 
.
ÉÉ 
Headers
ÉÉ 
.
ÉÉ 
Add
ÉÉ  
(
ÉÉ  !
$str
ÉÉ! =
,
ÉÉ= >
$str
ÉÉ? L
)
ÉÉL M
;
ÉÉM N
context
ÑÑ 
.
ÑÑ 
Response
ÑÑ 
.
ÑÑ 
Headers
ÑÑ 
.
ÑÑ 
Add
ÑÑ  
(
ÑÑ  !
$str
ÑÑ! ?
,
ÑÑ? @
$str
ÑÑA N
)
ÑÑN O
;
ÑÑO P
await
ÜÜ 	
next
ÜÜ
 
(
ÜÜ 
)
ÜÜ 
;
ÜÜ 
}áá 
)
áá 
;
áá 
appãã 
.
ãã 
UseCors
ãã 
(
ãã 
)
ãã 
;
ãã 
appçç 
.
çç 
UseStaticFiles
çç 
(
çç 
)
çç 
;
çç 
appèè 
.
èè 

UseRouting
èè 
(
èè 
)
èè 
;
èè 
appëë 
.
ëë 
UseAuthentication
ëë 
(
ëë 
)
ëë 
;
ëë 
appíí 
.
íí 
UseAuthorization
íí 
(
íí 
)
íí 
;
íí 
appìì 
.
ìì 

UseSession
ìì 
(
ìì 
)
ìì 
;
ìì 
appïï 
.
ïï  
MapControllerRoute
ïï 
(
ïï 
name
ññ 
:
ññ 	
$str
ññ
 
,
ññ 
pattern
óó 
:
óó 
$str
óó 6
)
óó6 7
;
óó7 8
appôô 
.
ôô 
Run
ôô 
(
ôô 
)
ôô 	
;
ôô	 
Ÿ
`C:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Models\ErrorViewModel.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Models 
{ 
public 

class 
ErrorViewModel 
{ 
public 
string 
? 
	RequestId  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 
bool 
ShowRequestId !
=>" $
!% &
string& ,
., -
IsNullOrEmpty- :
(: ;
	RequestId; D
)D E
;E F
} 
}		 ö
iC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Models\ChangePasswordViewModel.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Models 
{ 
public 

class #
ChangePasswordViewModel (
{ 
[ 	
Required	 
] 
[ 	
DataType	 
( 
DataType 
. 
Password #
)# $
]$ %
[		 	
Display			 
(		 
Name		 
=		 
$str		 +
)		+ ,
]		, -
public

 
string

 
CurrentPassword

 %
{

& '
get

( +
;

+ ,
set

- 0
;

0 1
}

2 3
[ 	
Required	 
] 
[ 	
DataType	 
( 
DataType 
. 
Password #
)# $
]$ %
[ 	
Display	 
( 
Name 
= 
$str *
)* +
]+ ,
public 
string 
NewPassword !
{" #
get$ '
;' (
set) ,
;, -
}. /
[ 	
Required	 
] 
[ 	
DataType	 
( 
DataType 
. 
Password #
)# $
]$ %
[ 	
Display	 
( 
Name 
= 
$str 4
)4 5
]5 6
[ 	
Compare	 
( 
$str 
, 
ErrorMessage  ,
=- .
$str/ u
)u v
]v w
public 
string 
ConfirmPassword %
{& '
get( +
;+ ,
set- 0
;0 1
}2 3
[ 	
Required	 
] 
[ 	
Display	 
( 
Name 
= 
$str 0
)0 1
]1 2
public 
string 
VerificationCode &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
} 
} Ã≠
rC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\SolicitudPrestamoController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class '
SolicitudPrestamoController ,
:- .

Controller/ 9
{ 
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 
ResumenClienteData +
_resumenClienteData, ?
;? @
private 
readonly 
EmailService %
_emailService& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
public '
SolicitudPrestamoController *
(* +
PrestamoData+ 7
prestamoData8 D
,D E
ClienteDataF Q
clienteDataR ]
,] ^
ResumenClienteData_ q
resumenClienteData	r Ñ
,
Ñ Ö
EmailService
Ü í
emailService
ì ü
,
ü †
AuditoriaService
° ±
auditoriaService
≤ ¬
)
¬ √
{ 	
_prestamoData 
= 
prestamoData (
;( )
_clienteData 
= 
clienteData &
;& '
_resumenClienteData 
=  !
resumenClienteData" 4
;4 5
_emailService 
= 
emailService (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
[!! 	
HttpGet!!	 
]!! 
["" 	
	Authorize""	 
("" 
Roles"" 
="" 
$str"" $
)""$ %
]""% &
public## 
async## 
Task## 
<## 
IActionResult## '
>##' ( 
ObtenerCedulaCliente##) =
(##= >
)##> ?
{$$ 	
var%% 
correo%% 
=%% 
User%% 
.%% 
	FindFirst%% '
(%%' (

ClaimTypes%%( 2
.%%2 3
Email%%3 8
)%%8 9
?%%9 :
.%%: ;
Value%%; @
;%%@ A
if&& 
(&& 
string&& 
.&& 
IsNullOrEmpty&& $
(&&$ %
correo&&% +
)&&+ ,
)&&, -
{'' 
return(( 
RedirectToAction(( '
(((' (
$str((( /
,((/ 0
$str((1 7
)((7 8
;((8 9
})) 
var++ 
cliente++ 
=++ 
await++ 
_clienteData++  ,
.++, -
ObtenerPorCorreo++- =
(++= >
correo++> D
)++D E
;++E F
if,, 
(,, 
cliente,, 
==,, 
null,, 
),,  
{-- 
return.. 
RedirectToAction.. '
(..' (
$str..( /
,../ 0
$str..1 7
)..7 8
;..8 9
}// 
Console00 
.00 
	WriteLine00 
(00 
$str00 :
,00: ;
cliente00; B
.00B C
NroDocumento00C O
)00O P
;00P Q
return11 
Ok11 
(11 
new11 
{11 
cedula11 "
=11# $
cliente11% ,
.11, -
NroDocumento11- 9
}11: ;
)11; <
;11< =
}33 	
[55 	
HttpPost55	 
]55 
[66 	
	Authorize66	 
(66 
Roles66 
=66 
$str66 $
)66$ %
]66% &
public77 
async77 
Task77 
<77 
IActionResult77 '
>77' (
CrearSolicitud77) 7
(777 8
[778 9
FromBody779 A
]77A B
SolicitudPrestamo77C T
	solicitud77U ^
)77^ _
{88 	
if99 
(99 
!99 

ModelState99 
.99 
IsValid99 #
)99# $
{:: 
return;; 

BadRequest;; !
(;;! "

ModelState;;" ,
);;, -
;;;- .
}<< 
var== 
userId== 
=== 
User== 
.== 
	FindFirst== '
(==' (

ClaimTypes==( 2
.==2 3
NameIdentifier==3 A
)==A B
?==B C
.==C D
Value==D I
;==I J
if>> 
(>> 
userId>> 
==>> 
null>> 
)>> 
{?? 
return@@ 
Json@@ 
(@@ 
new@@ 
{@@  !
success@@" )
=@@* +
false@@, 1
,@@1 2
message@@3 :
=@@; <
$str@@= U
}@@V W
)@@W X
;@@X Y
}AA 
	solicitudCC 
.CC 
	IdUsuarioCC 
=CC  !
intCC" %
.CC% &
ParseCC& +
(CC+ ,
userIdCC, 2
)CC2 3
;CC3 4
	solicitudDD 
.DD 
EstadoDD 
=DD 
$strDD *
;DD* +
	solicitudEE 
.EE 
FechaSolicitudEE $
=EE% &
DateTimeEE' /
.EE/ 0
NowEE0 3
;EE3 4
ifHH 
(HH 
	solicitudHH 
.HH 
NumeroHijosHH %
>HH& '
$numHH( )
)HH) *
{II 
	solicitudJJ 
.JJ 
MontoJJ 
-=JJ  "
	solicitudJJ# ,
.JJ, -
NumeroHijosJJ- 8
*JJ9 :
$numJJ; >
;JJ> ?
}KK 
varNN 
	historialNN 
=NN 
awaitNN !
_prestamoDataNN" /
.NN/ 0&
ObtenerHistorialCrediticioNN0 J
(NNJ K
	solicitudNNK T
.NNT U
	IdUsuarioNNU ^
)NN^ _
;NN_ `
ifOO 
(OO 
	historialOO 
==OO 
nullOO !
)OO! "
{PP 
	historialQQ 
=QQ 
newQQ 
	EntidadesQQ  )
.QQ) *
HistorialCrediticioQQ* =
{QQ> ?
	IdUsuarioQQ@ I
=QQJ K
	solicitudQQL U
.QQU V
	IdUsuarioQQV _
,QQ_ `
EstadoCrediticioQQa q
=QQr s
$numQQt u
}QQv w
;QQw x
awaitRR 
_auditoriaServiceRR '
.RR' (
RegistrarLogRR( 4
(RR4 5
UserRR5 9
.RR9 :
IdentityRR: B
.RRB C
NameRRC G
,RRG H
$strRRI P
,RRP Q
$"RRR T
$str	RRT Ö
{
RRÖ Ü
	solicitud
RRÜ è
.
RRè ê
	IdUsuario
RRê ô
}
RRô ö
"
RRö õ
)
RRõ ú
;
RRú ù
awaitSS 
_prestamoDataSS #
.SS# $$
CrearHistorialCrediticioSS$ <
(SS< =
	historialSS= F
)SSF G
;SSG H
}TT 
elseUU 
ifUU 
(UU 
	historialUU 
.UU 
EstadoCrediticioUU /
<UU0 1
$numUU2 3
)UU3 4
{VV 
returnWW 
JsonWW 
(WW 
newWW 
{WW  !
successWW" )
=WW* +
falseWW, 1
,WW1 2
messageWW3 :
=WW; <
$strWW= y
}WWz {
)WW{ |
;WW| }
}XX 
var[[ 
correo[[ 
=[[ 
User[[ 
.[[ 
	FindFirst[[ '
([[' (

ClaimTypes[[( 2
.[[2 3
Email[[3 8
)[[8 9
?[[9 :
.[[: ;
Value[[; @
;[[@ A
var\\ 
cliente\\ 
=\\ 
await\\ 
_clienteData\\  ,
.\\, -
ObtenerPorCorreo\\- =
(\\= >
correo\\> D
)\\D E
;\\E F
var]] 
prestamo]] 
=]] 
await]]  
_prestamoData]]! .
.]]. /'
ObtenerIdPrestamoPorCliente]]/ J
(]]J K
cliente]]K R
.]]R S
	IdCliente]]S \
)]]\ ]
;]]] ^
var^^ 
resumen^^ 
=^^ 
await^^ 
_resumenClienteData^^  3
.^^3 4
ObtenerResumen^^4 B
(^^B C
cliente^^C J
.^^J K
	IdCliente^^K T
,^^T U
prestamo^^V ^
)^^^ _
;^^_ `
Console__ 
.__ 
	WriteLine__ 
(__ 
resumen__ %
.__% &"
PagosClientePendientes__& <
)__< =
;__= >
if`` 
(`` 
resumen`` 
.`` "
PagosClientePendientes`` .
!=``/ 1
$str``2 5
)``5 6
{aa 
returnbb 
Jsonbb 
(bb 
newbb 
{bb  !
successbb" )
=bb* +
falsebb, 1
,bb1 2
messagebb3 :
=bb; <
$strbb= p
}bbq r
)bbr s
;bbs t
}cc 
ifee 
(ee 
	solicitudee 
.ee 
Montoee 
>ee  !
	solicitudee" +
.ee+ ,
Sueldoee, 2
*ee3 4
$numee5 6
)ee6 7
{ff 
returngg 
Jsongg 
(gg 
newgg 
{gg  !
successgg" )
=gg* +
falsegg, 1
,gg1 2
messagegg3 :
=gg; <
$str	gg= à
}
ggâ ä
)
ggä ã
;
ggã å
}hh 
booljj 
	resultadojj 
=jj 
awaitjj "
_prestamoDatajj# 0
.jj0 1"
CrearSolicitudPrestamojj1 G
(jjG H
	solicitudjjH Q
)jjQ R
;jjR S
ifkk 
(kk 
	resultadokk 
)kk 
{ll 
awaitmm 
_auditoriaServicemm '
.mm' (
RegistrarLogmm( 4
(mm4 5
Usermm5 9
.mm9 :
Identitymm: B
.mmB C
NamemmC G
,mmG H
$strmmI P
,mmP Q
$"mmR T
$str	mmT Ü
{
mmÜ á
	solicitud
mmá ê
.
mmê ë
	IdUsuario
mmë ö
}
mmö õ
"
mmõ ú
)
mmú ù
;
mmù û
}nn 
returnoo 
Jsonoo 
(oo 
newoo 
{oo 
successoo %
=oo& '
	resultadooo( 1
}oo2 3
)oo3 4
;oo4 5
}pp 	
[rr 	
	Authorizerr	 
(rr 
Rolesrr 
=rr 
$strrr *
)rr* +
]rr+ ,
publicss 
IActionResultss  
GestionarSolicitudesss 1
(ss1 2
)ss2 3
{tt 	
returnuu 
Viewuu 
(uu 
)uu 
;uu 
}vv 	
[xx 	
	Authorizexx	 
(xx 
Rolesxx 
=xx 
$strxx *
)xx* +
]xx+ ,
[yy 	
HttpGetyy	 
]yy 
publiczz 
asynczz 
Taskzz 
<zz 
IActionResultzz '
>zz' ((
ObtenerSolicitudesPendienteszz) E
(zzE F
)zzF G
{{{ 	
var|| 
solicitudes|| 
=|| 
await|| #
_prestamoData||$ 1
.||1 2(
ObtenerSolicitudesPendientes||2 N
(||N O
)||O P
;||P Q
return}} 
Json}} 
(}} 
new}} 
{}} 
data}} "
=}}# $
solicitudes}}% 0
}}}1 2
)}}2 3
;}}3 4
}~~ 	
[
ÄÄ 	
	Authorize
ÄÄ	 
(
ÄÄ 
Roles
ÄÄ 
=
ÄÄ 
$str
ÄÄ *
)
ÄÄ* +
]
ÄÄ+ ,
[
ÅÅ 	
HttpGet
ÅÅ	 
]
ÅÅ 
public
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
IActionResult
ÇÇ '
>
ÇÇ' (
ObtenerSolicitud
ÇÇ) 9
(
ÇÇ9 :
int
ÇÇ: =
id
ÇÇ> @
)
ÇÇ@ A
{
ÉÉ 	
if
ÑÑ 
(
ÑÑ 
!
ÑÑ 

ModelState
ÑÑ 
.
ÑÑ 
IsValid
ÑÑ #
)
ÑÑ# $
{
ÖÖ 
return
ÜÜ 

BadRequest
ÜÜ !
(
ÜÜ! "

ModelState
ÜÜ" ,
)
ÜÜ, -
;
ÜÜ- .
}
áá 
var
àà 
	solicitud
àà 
=
àà 
await
àà !
_prestamoData
àà" /
.
àà/ 0#
ObtenerSolicitudPorId
àà0 E
(
ààE F
id
ààF H
)
ààH I
;
ààI J
if
ââ 
(
ââ 
	solicitud
ââ 
==
ââ 
null
ââ !
)
ââ! "
{
ää 
return
ãã 
Json
ãã 
(
ãã 
new
ãã 
{
ãã  !
success
ãã" )
=
ãã* +
false
ãã, 1
,
ãã1 2
message
ãã3 :
=
ãã; <
$str
ãã= V
}
ããW X
)
ããX Y
;
ããY Z
}
åå 
return
çç 
Json
çç 
(
çç 
new
çç 
{
çç 
success
çç %
=
çç& '
true
çç( ,
,
çç, -
data
çç. 2
=
çç3 4
	solicitud
çç5 >
}
çç? @
)
çç@ A
;
ççA B
}
éé 	
[
êê 	
	Authorize
êê	 
(
êê 
Roles
êê 
=
êê 
$str
êê *
)
êê* +
]
êê+ ,
[
ëë 	
HttpPost
ëë	 
]
ëë 
public
íí 
async
íí 
Task
íí 
<
íí 
IActionResult
íí '
>
íí' ('
ActualizarEstadoSolicitud
íí) B
(
ííB C
[
ííC D
FromBody
ííD L
]
ííL M*
SolicitudEstadoUpdateRequest
ííN j
request
íík r
)
íír s
{
ìì 	
if
îî 
(
îî 
!
îî 

ModelState
îî 
.
îî 
IsValid
îî #
)
îî# $
{
ïï 
return
ññ 

BadRequest
ññ !
(
ññ! "

ModelState
ññ" ,
)
ññ, -
;
ññ- .
}
óó 
try
òò 
{
ôô 
bool
öö 
	resultado
öö 
=
öö  
await
öö! &
_prestamoData
öö' 4
.
öö4 5'
ActualizarEstadoSolicitud
öö5 N
(
ööN O
request
ööO V
.
ööV W
Id
ööW Y
,
ööY Z
request
öö[ b
.
ööb c
Estado
ööc i
)
ööi j
;
ööj k
if
õõ 
(
õõ 
	resultado
õõ 
)
õõ 
{
úú 
var
ùù 
	solicitud
ùù !
=
ùù" #
await
ùù$ )
_prestamoData
ùù* 7
.
ùù7 8#
ObtenerSolicitudPorId
ùù8 M
(
ùùM N
request
ùùN U
.
ùùU V
Id
ùùV X
)
ùùX Y
;
ùùY Z
if
ûû 
(
ûû 
	solicitud
ûû !
==
ûû" $
null
ûû% )
)
ûû) *
{
üü 
return
†† 
Json
†† #
(
††# $
new
††$ '
{
††( )
success
††* 1
=
††2 3
false
††4 9
,
††9 :
message
††; B
=
††C D
$str
††E ^
}
††_ `
)
††` a
;
††a b
}
°° 
var
££ 
cliente
££ 
=
££  !
await
££" '
_clienteData
££( 4
.
££4 5
ObtenerPorCedula
££5 E
(
££E F
	solicitud
££F O
.
££O P
Cedula
££P V
)
££V W
;
££W X
if
§§ 
(
§§ 
cliente
§§ 
==
§§  "
null
§§# '
)
§§' (
{
•• 
return
¶¶ 
Json
¶¶ #
(
¶¶# $
new
¶¶$ '
{
¶¶( )
success
¶¶* 1
=
¶¶2 3
false
¶¶4 9
,
¶¶9 :
message
¶¶; B
=
¶¶C D
$str
¶¶E \
}
¶¶] ^
)
¶¶^ _
;
¶¶_ `
}
ßß 
if
©© 
(
©© 
request
©© 
.
©©  
Estado
©©  &
==
©©' )
$str
©©* 5
)
©©5 6
{
™™ 
string
´´ 
asunto
´´ %
=
´´& '
$str
´´( I
;
´´I J
string
¨¨ 
mensaje
¨¨ &
=
¨¨' (
$"
¨¨) +
$str
¨¨+ 4
{
¨¨4 5
cliente
¨¨5 <
.
¨¨< =
Nombre
¨¨= C
+
¨¨D E
$str
¨¨F I
+
¨¨J K
cliente
¨¨L S
.
¨¨S T
Apellido
¨¨T \
}
¨¨\ ]
$str¨¨] ·
"¨¨· ‚
;¨¨‚ „
await
≠≠ 
_auditoriaService
≠≠ /
.
≠≠/ 0
RegistrarLog
≠≠0 <
(
≠≠< =
User
≠≠= A
.
≠≠A B
Identity
≠≠B J
.
≠≠J K
Name
≠≠K O
,
≠≠O P
$str
≠≠Q ]
,
≠≠] ^
$"
≠≠_ a
$str≠≠a ñ
{≠≠ñ ó
cliente≠≠ó û
.≠≠û ü
	IdCliente≠≠ü ®
}≠≠® ©
"≠≠© ™
)≠≠™ ´
;≠≠´ ¨
await
ÆÆ 
_emailService
ÆÆ +
.
ÆÆ+ ,
EnviarCorreoAsync
ÆÆ, =
(
ÆÆ= >
cliente
ÆÆ> E
.
ÆÆE F
Correo
ÆÆF L
,
ÆÆL M
asunto
ÆÆN T
,
ÆÆT U
mensaje
ÆÆV ]
)
ÆÆ] ^
;
ÆÆ^ _
}
ØØ 
else
∞∞ 
if
∞∞ 
(
∞∞ 
request
∞∞ $
.
∞∞$ %
Estado
∞∞% +
==
∞∞, .
$str
∞∞/ 9
)
∞∞9 :
{
±± 
var
≥≥ 
	historial
≥≥ %
=
≥≥& '
await
≥≥( -
_prestamoData
≥≥. ;
.
≥≥; <(
ObtenerHistorialCrediticio
≥≥< V
(
≥≥V W
	solicitud
≥≥W `
.
≥≥` a
	IdUsuario
≥≥a j
)
≥≥j k
;
≥≥k l
if
¥¥ 
(
¥¥ 
	historial
¥¥ %
!=
¥¥& (
null
¥¥) -
)
¥¥- .
{
µµ 
await
∂∂ !
_prestamoData
∂∂" /
.
∂∂/ 0+
ActualizarHistorialCrediticio
∂∂0 M
(
∂∂M N
	historial
∂∂N W
.
∂∂W X
	IdUsuario
∂∂X a
,
∂∂a b
true
∂∂c g
)
∂∂g h
;
∂∂h i
}
∑∑ 
string
ππ 
asunto
ππ %
=
ππ& '
$str
ππ( H
;
ππH I
string
∫∫ 
mensaje
∫∫ &
=
∫∫' (
$"
∫∫) +
$str
∫∫+ 4
{
∫∫4 5
cliente
∫∫5 <
.
∫∫< =
Nombre
∫∫= C
+
∫∫D E
$str
∫∫F I
+
∫∫J K
cliente
∫∫L S
.
∫∫S T
Apellido
∫∫T \
}
∫∫\ ]
$str∫∫] ÿ
"∫∫ÿ Ÿ
;∫∫Ÿ ⁄
await
ªª 
_emailService
ªª +
.
ªª+ ,
EnviarCorreoAsync
ªª, =
(
ªª= >
cliente
ªª> E
.
ªªE F
Correo
ªªF L
,
ªªL M
asunto
ªªN T
,
ªªT U
mensaje
ªªV ]
)
ªª] ^
;
ªª^ _
await
ºº 
_auditoriaService
ºº /
.
ºº/ 0
RegistrarLog
ºº0 <
(
ºº< =
User
ºº= A
.
ººA B
Identity
ººB J
.
ººJ K
Name
ººK O
,
ººO P
$str
ººQ ]
,
ºº] ^
$"
ºº_ a
$strººa ï
{ººï ñ
clienteººñ ù
.ººù û
	IdClienteººû ß
}ººß ®
"ºº® ©
)ºº© ™
;ºº™ ´
return
ææ 
Json
ææ #
(
ææ# $
new
ææ$ '
{
ææ( )
success
ææ* 1
=
ææ2 3
true
ææ4 8
,
ææ8 9
redirectUrl
ææ: E
=
ææF G
$str
ææH Y
,
ææY Z
	historial
ææ[ d
}
ææe f
)
ææf g
;
ææg h
}
øø 
}
¿¿ 
return
¡¡ 
Json
¡¡ 
(
¡¡ 
new
¡¡ 
{
¡¡  !
success
¡¡" )
=
¡¡* +
	resultado
¡¡, 5
}
¡¡6 7
)
¡¡7 8
;
¡¡8 9
}
¬¬ 
catch
√√ 
(
√√ 
	Exception
√√ 
ex
√√ 
)
√√  
{
ƒƒ 
Console
∆∆ 
.
∆∆ 
	WriteLine
∆∆ !
(
∆∆! "
ex
∆∆" $
.
∆∆$ %
Message
∆∆% ,
)
∆∆, -
;
∆∆- .
return
«« 

StatusCode
«« !
(
««! "
StatusCodes
««" -
.
««- .*
Status500InternalServerError
««. J
,
««J K
new
««L O
{
««P Q
success
««R Y
=
««Z [
false
««\ a
,
««a b
message
««c j
=
««k l
$str««m ú
}««ù û
)««û ü
;««ü †
}
»» 
}
…… 	
public
ÀÀ 
class
ÀÀ *
SolicitudEstadoUpdateRequest
ÀÀ 1
{
ÃÃ 	
public
ÕÕ 
int
ÕÕ 
Id
ÕÕ 
{
ÕÕ 
get
ÕÕ 
;
ÕÕ  
set
ÕÕ! $
;
ÕÕ$ %
}
ÕÕ& '
public
ŒŒ 
string
ŒŒ 
Estado
ŒŒ  
{
ŒŒ! "
get
ŒŒ# &
;
ŒŒ& '
set
ŒŒ( +
;
ŒŒ+ ,
}
ŒŒ- .
}
œœ 	
}
–– 
}—— ∫3
iC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\RegisterController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
public 

class 
RegisterController #
:$ %

Controller& 0
{ 
private 
readonly 
UsuarioData $
_usuarioData% 1
;1 2
public 
RegisterController !
(! "
UsuarioData" -
usuarioData. 9
)9 :
{ 	
_usuarioData 
= 
usuarioData &
;& '
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[ 	
HttpPost	 
] 
[ 	$
ValidateAntiForgeryToken	 !
]! "
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
string/ 5
nombreCompleto6 D
,D E
stringF L
correoM S
,S T
stringU [
clave\ a
)a b
{   	
if!! 
(!! 
string!! 
.!! 
IsNullOrEmpty!! $
(!!$ %
nombreCompleto!!% 3
)!!3 4
||!!5 7
string!!8 >
.!!> ?
IsNullOrEmpty!!? L
(!!L M
correo!!M S
)!!S T
||!!U W
string!!X ^
.!!^ _
IsNullOrEmpty!!_ l
(!!l m
clave!!m r
)!!r s
)!!s t
{"" 
ViewData## 
[## 
$str## "
]##" #
=##$ %
$str##& I
;##I J
return$$ 
View$$ 
($$ 
)$$ 
;$$ 
}%% 
if(( 
((( 
!(( 
Regex(( 
.(( 
IsMatch(( 
((( 
correo(( %
,((% &
$str((' D
,((D E
RegexOptions((F R
.((R S
None((S W
,((W X
TimeSpan((Y a
.((a b
FromMilliseconds((b r
(((r s
$num((s v
)((v w
)((w x
)((x y
{)) 
ViewData** 
[** 
$str** "
]**" #
=**$ %
$str**& O
;**O P
return++ 
View++ 
(++ 
)++ 
;++ 
},, 
var// 
usuarioExistente//  
=//! "
await//# (
_usuarioData//) 5
.//5 6
ObtenerPorCorreo//6 F
(//F G
correo//G M
)//M N
;//N O
if00 
(00 
usuarioExistente00  
!=00! #
null00$ (
)00( )
{11 
ViewData22 
[22 
$str22 "
]22" #
=22$ %
$str22& P
;22P Q
return33 
View33 
(33 
)33 
;33 
}44 
string77 
hashedClave77 
=77  
BCrypt77! '
.77' (
Net77( +
.77+ ,
BCrypt77, 2
.772 3
HashPassword773 ?
(77? @
clave77@ E
)77E F
;77F G
Usuario99 
nuevoUsuario99  
=99! "
new99# &
Usuario99' .
{:: 
NombreCompleto;; 
=;;  
nombreCompleto;;! /
,;;/ 0
Correo<< 
=<< 
correo<< 
,<<  
Clave== 
=== 
hashedClave== #
,==# $
Rol>> 
=>> 
$str>> %
}?? 
;?? 
boolAA 
usuarioCreadoAA 
=AA  
awaitAA! &
_usuarioDataAA' 3
.AA3 4
CrearAA4 9
(AA9 :
nuevoUsuarioAA: F
)AAF G
;AAG H
ifCC 
(CC 
!CC 
usuarioCreadoCC 
)CC 
{DD 
ViewDataEE 
[EE 
$strEE "
]EE" #
=EE$ %
$strEE& A
;EEA B
returnFF 
ViewFF 
(FF 
)FF 
;FF 
}GG 
ViewDataII 
[II 
$strII 
]II 
=II  !
$strII" ?
;II? @
ListLL 
<LL 
ClaimLL 
>LL 
claimsLL 
=LL  
newLL! $
ListLL% )
<LL) *
ClaimLL* /
>LL/ 0
{MM 
newNN 
ClaimNN 
(NN 

ClaimTypesNN $
.NN$ %
NameNN% )
,NN) *
nuevoUsuarioNN+ 7
.NN7 8
NombreCompletoNN8 F
)NNF G
,NNG H
newOO 
ClaimOO 
(OO 

ClaimTypesOO $
.OO$ %
NameIdentifierOO% 3
,OO3 4
nuevoUsuarioOO5 A
.OOA B
	IdUsuarioOOB K
.OOK L
ToStringOOL T
(OOT U
)OOU V
)OOV W
,OOW X
newPP 
ClaimPP 
(PP 

ClaimTypesPP $
.PP$ %
RolePP% )
,PP) *
nuevoUsuarioPP+ 7
.PP7 8
RolPP8 ;
)PP; <
}QQ 
;QQ 
ClaimsIdentitySS 
claimsIdentitySS )
=SS* +
newSS, /
ClaimsIdentitySS0 >
(SS> ?
claimsSS? E
,SSE F(
CookieAuthenticationDefaultsSSG c
.SSc d 
AuthenticationSchemeSSd x
)SSx y
;SSy z$
AuthenticationPropertiesTT $

propertiesTT% /
=TT0 1
newTT2 5$
AuthenticationPropertiesTT6 N
{UU 
AllowRefreshVV 
=VV 
trueVV #
}WW 
;WW 
awaitYY 
HttpContextYY 
.YY 
SignInAsyncYY )
(YY) *(
CookieAuthenticationDefaultsYY* F
.YYF G 
AuthenticationSchemeYYG [
,YY[ \
newYY] `
ClaimsPrincipalYYa p
(YYp q
claimsIdentityYYq 
)	YY Ä
,
YYÄ Å

properties
YYÇ å
)
YYå ç
;
YYç é
returnZZ 
RedirectToActionZZ #
(ZZ# $
$strZZ$ +
,ZZ+ ,
$strZZ- 3
)ZZ3 4
;ZZ4 5
}[[ 	
}\\ 
}]] ´ò
iC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\PrestamoController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
PrestamoController #
:$ %

Controller& 0
{ 
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
PrestamoController !
(! "
ClienteData" -
clienteData. 9
,9 :
PrestamoData; G
prestamoDataH T
,T U
AuditoriaServiceV f
auditoriaServiceg w
)w x
{ 	
_clienteData 
= 
clienteData &
;& '
_prestamoData 
= 
prestamoData (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
public   
IActionResult   
Nuevo   "
(  " #
)  # $
{!! 	
return"" 
View"" 
("" 
)"" 
;"" 
}## 	
[%% 	
HttpGet%%	 
]%% 
[&& 	
	Authorize&&	 
(&& 
Roles&& 
=&& 
$str&& 2
)&&2 3
]&&3 4
public'' 
async'' 
Task'' 
<'' 
IActionResult'' '
>''' (
ObtenerCliente'') 7
(''7 8
string''8 >
NroDocumento''? K
)''K L
{(( 	
Cliente)) 
objeto)) 
=)) 
await)) "
_clienteData))# /
.))/ 0
Obtener))0 7
())7 8
NroDocumento))8 D
)))D E
;))E F
return** 

StatusCode** 
(** 
StatusCodes** )
.**) *
Status200OK*** 5
,**5 6
new**7 :
{**; <
data**= A
=**B C
objeto**D J
}**K L
)**L M
;**M N
}++ 	
[-- 	
HttpGet--	 
]-- 
[.. 	
	Authorize..	 
(.. 
Roles.. 
=.. 
$str.. 3
)..3 4
]..4 5
public// 
async// 
Task// 
<// 
IActionResult// '
>//' ( 
ObtenerCedulaCliente//) =
(//= >
)//> ?
{00 	
var11 
correo11 
=11 
User11 
.11 
	FindFirst11 '
(11' (

ClaimTypes11( 2
.112 3
Email113 8
)118 9
?119 :
.11: ;
Value11; @
;11@ A
Console22 
.22 
	WriteLine22 
(22 
correo22 $
)22$ %
;22% &
if33 
(33 
string33 
.33 
IsNullOrEmpty33 $
(33$ %
correo33% +
)33+ ,
)33, -
{44 
return55 
RedirectToAction55 '
(55' (
$str55( /
,55/ 0
$str551 7
)557 8
;558 9
}66 
var88 
cliente88 
=88 
await88 
_clienteData88  ,
.88, -
ObtenerPorCorreo88- =
(88= >
correo88> D
)88D E
;88E F
Console99 
.99 
	WriteLine99 
(99 
cliente99 %
.99% &
NroDocumento99& 2
)992 3
;993 4
if:: 
(:: 
cliente:: 
==:: 
null:: 
)::  
{;; 
return<< 
RedirectToAction<< '
(<<' (
$str<<( /
,<</ 0
$str<<1 7
)<<7 8
;<<8 9
}== 
return>> 
Ok>> 
(>> 
new>> 
{>> 
cedula>> "
=>># $
cliente>>% ,
.>>, -
NroDocumento>>- 9
}>>: ;
)>>; <
;>>< =
}@@ 	
[BB 	
HttpPostBB	 
]BB 
[CC 	
	AuthorizeCC	 
(CC 
RolesCC 
=CC 
$strCC *
)CC* +
]CC+ ,
publicDD 
asyncDD 
TaskDD 
<DD 
IActionResultDD '
>DD' (
CrearDD) .
(DD. /
[DD/ 0
FromBodyDD0 8
]DD8 9
PrestamoDD: B
.DDB C
	EntidadesDDC L
.DDL M
PrestamoDDM U
objetoDDV \
)DD\ ]
{EE 	
ifFF 
(FF 
!FF 

ModelStateFF 
.FF 
IsValidFF #
)FF# $
{GG 
returnHH 

BadRequestHH !
(HH! "

ModelStateHH" ,
)HH, -
;HH- .
}II 
stringJJ 
	respuestaJJ 
=JJ 
awaitJJ $
_prestamoDataJJ% 2
.JJ2 3
CrearJJ3 8
(JJ8 9
objetoJJ9 ?
)JJ? @
;JJ@ A
awaitKK 
_auditoriaServiceKK #
.KK# $
RegistrarLogKK$ 0
(KK0 1
UserKK1 5
.KK5 6
IdentityKK6 >
.KK> ?
NameKK? C
,KKC D
$strKKE L
,KKL M
$"KKN P
$strKKP a
{KKa b
objetoKKb h
.KKh i

IdPrestamoKKi s
}KKs t
"KKt u
)KKu v
;KKv w
returnLL 

StatusCodeLL 
(LL 
StatusCodesLL )
.LL) *
Status200OKLL* 5
,LL5 6
newLL7 :
{LL; <
dataLL= A
=LLB C
	respuestaLLD M
}LLN O
)LLO P
;LLP Q
}MM 	
[PP 	
HttpGetPP	 
]PP 
[QQ 	
	AuthorizeQQ	 
(QQ 
RolesQQ 
=QQ 
$strQQ 3
)QQ3 4
]QQ4 5
publicRR 
asyncRR 
TaskRR 
<RR 
IActionResultRR '
>RR' (
ObtenerPrestamosRR) 9
(RR9 :
intRR: =

IdPrestamoRR> H
,RRH I
stringRRJ P
NroDocumentoRRQ ]
)RR] ^
{SS 	
ifTT 
(TT 
!TT 

ModelStateTT 
.TT 
IsValidTT #
)TT# $
{UU 
returnVV 

BadRequestVV !
(VV! "

ModelStateVV" ,
)VV, -
;VV- .
}WW 
ListXX 
<XX 
PrestamoXX 
.XX 
	EntidadesXX #
.XX# $
PrestamoXX$ ,
>XX, -
objetoXX. 4
=XX5 6
awaitXX7 <
_prestamoDataXX= J
.XXJ K
ObtenerPrestamosXXK [
(XX[ \

IdPrestamoXX\ f
,XXf g
NroDocumentoXXg s
==XXt v
nullXXw {
?XX| }
$str	XX~ Ä
:
XXÄ Å
NroDocumento
XXÇ é
)
XXé è
;
XXè ê
returnYY 

StatusCodeYY 
(YY 
StatusCodesYY )
.YY) *
Status200OKYY* 5
,YY5 6
newYY7 :
{YY; <
dataYY= A
=YYB C
objetoYYD J
}YYK L
)YYL M
;YYM N
}ZZ 	
[\\ 	
HttpGet\\	 
]\\ 
[]] 	
	Authorize]]	 
(]] 
Roles]] 
=]] 
$str]] *
)]]* +
]]]+ ,
public^^ 
async^^ 
Task^^ 
<^^ 
IActionResult^^ '
>^^' (
ImprimirPrestamo^^) 9
(^^9 :
int^^: =

IdPrestamo^^> H
)^^H I
{__ 	
if`` 
(`` 
!`` 

ModelState`` 
.`` 
IsValid`` #
)``# $
{aa 
returnbb 

BadRequestbb !
(bb! "

ModelStatebb" ,
)bb, -
;bb- .
}cc 
Listdd 
<dd 
Prestamodd 
.dd 
	Entidadesdd #
.dd# $
Prestamodd$ ,
>dd, -
listadd. 3
=dd4 5
awaitdd6 ;
_prestamoDatadd< I
.ddI J
ObtenerPrestamosddJ Z
(ddZ [

IdPrestamodd[ e
,dde f
$strddg i
)ddi j
;ddj k
Prestamoee 
.ee 
	Entidadesee 
.ee 
Prestamoee '
objetoee( .
=ee/ 0
listaee1 6
[ee6 7
$numee7 8
]ee8 9
;ee9 :
QuestPDFgg 
.gg 
Settingsgg 
.gg 
Licensegg %
=gg& '
QuestPDFgg( 0
.gg0 1
Infrastructuregg1 ?
.gg? @
LicenseTypegg@ K
.ggK L
	CommunityggL U
;ggU V
varhh 
pdfhh 
=hh 
Documenthh 
.hh 
Createhh %
(hh% &
documenthh& .
=>hh/ 1
{ii 
documentjj 
.jj 
Pagejj 
(jj 
pagejj "
=>jj# %
{kk 
pagemm 
.mm 
Marginmm 
(mm  
$nummm  "
)mm" #
;mm# $
pageoo 
.oo 
Headeroo 
(oo  
)oo  !
.oo! "
ShowOnceoo" *
(oo* +
)oo+ ,
.oo, -

Backgroundoo- 7
(oo7 8
$stroo8 A
)ooA B
.ooB C
PaddingooC J
(ooJ K
$numooK L
)ooL M
.ooM N
RowooN Q
(ooQ R
rowooR U
=>ooV X
{pp 
rowqq 
.qq 
RelativeItemqq (
(qq( )
)qq) *
.qq* +
	AlignLeftqq+ 4
(qq4 5
)qq5 6
.qq6 7
Textqq7 ;
(qq; <
$strqq< F
)qqF G
.qqG H
BoldqqH L
(qqL M
)qqM N
.qqN O
FontSizeqqO W
(qqW X
$numqqX Z
)qqZ [
;qq[ \
rowrr 
.rr 
RelativeItemrr (
(rr( )
)rr) *
.rr* +

AlignRightrr+ 5
(rr5 6
)rr6 7
.rr7 8
Textrr8 <
(rr< =
$"rr= ?
$strrr? D
{rrD E
objetorrE K
.rrK L

IdPrestamorrL V
}rrV W
"rrW X
)rrX Y
.rrY Z
BoldrrZ ^
(rr^ _
)rr_ `
.rr` a
FontSizerra i
(rri j
$numrrj l
)rrl m
;rrm n
}ss 
)ss 
;ss 
pageuu 
.uu 
Contentuu  
(uu  !
)uu! "
.uu" #
PaddingVerticaluu# 2
(uu2 3
$numuu3 5
)uu5 6
.uu6 7
Columnuu7 =
(uu= >
col1uu> B
=>uuC E
{vv 
col1ww 
.ww 
Spacingww $
(ww$ %
$numww% '
)ww' (
;ww( )
col1yy 
.yy 
Itemyy !
(yy! "
)yy" #
.yy# $
Columnyy$ *
(yy* +
col2yy+ /
=>yy0 2
{zz 
col2{{  
.{{  !
Spacing{{! (
({{( )
$num{{) *
){{* +
;{{+ ,
col2||  
.||  !
Item||! %
(||% &
)||& '
.||' (
Row||( +
(||+ ,
row||, /
=>||0 2
{}} 
row~~  #
.~~# $
RelativeItem~~$ 0
(~~0 1
)~~1 2
.~~2 3
BorderBottom~~3 ?
(~~? @
$num~~@ A
)~~A B
.~~B C
	AlignLeft~~C L
(~~L M
)~~M N
.~~N O
Text~~O S
(~~S T
$str~~T g
)~~g h
.~~h i
Bold~~i m
(~~m n
)~~n o
.~~o p
FontSize~~p x
(~~x y
$num~~y {
)~~{ |
;~~| }
} 
) 
; 
col2
ÄÄ  
.
ÄÄ  !
Item
ÄÄ! %
(
ÄÄ% &
)
ÄÄ& '
.
ÄÄ' (
Row
ÄÄ( +
(
ÄÄ+ ,
row
ÄÄ, /
=>
ÄÄ0 2
{
ÅÅ 
row
ÉÉ  #
.
ÉÉ# $
RelativeItem
ÉÉ$ 0
(
ÉÉ0 1
)
ÉÉ1 2
.
ÉÉ2 3
Column
ÉÉ3 9
(
ÉÉ9 :
col
ÉÉ: =
=>
ÉÉ> @
{
ÑÑ  !
col
ÖÖ$ '
.
ÖÖ' (
Item
ÖÖ( ,
(
ÖÖ, -
)
ÖÖ- .
.
ÖÖ. /
Text
ÖÖ/ 3
(
ÖÖ3 4
txt
ÖÖ4 7
=>
ÖÖ8 :
{
ÜÜ$ %
txt
áá( +
.
áá+ ,
Span
áá, 0
(
áá0 1
$str
áá1 E
)
ááE F
.
ááF G
SemiBold
ááG O
(
ááO P
)
ááP Q
.
ááQ R
FontSize
ááR Z
(
ááZ [
$num
áá[ ]
)
áá] ^
;
áá^ _
txt
àà( +
.
àà+ ,
Span
àà, 0
(
àà0 1
objeto
àà1 7
.
àà7 8
Cliente
àà8 ?
.
àà? @
NroDocumento
àà@ L
)
ààL M
.
ààM N
FontSize
ààN V
(
ààV W
$num
ààW Y
)
ààY Z
;
ààZ [
}
ââ$ %
)
ââ% &
;
ââ& '
col
ää$ '
.
ää' (
Item
ää( ,
(
ää, -
)
ää- .
.
ää. /
Text
ää/ 3
(
ää3 4
txt
ää4 7
=>
ää8 :
{
ãã$ %
txt
åå( +
.
åå+ ,
Span
åå, 0
(
åå0 1
$str
åå1 ;
)
åå; <
.
åå< =
SemiBold
åå= E
(
ååE F
)
ååF G
.
ååG H
FontSize
ååH P
(
ååP Q
$num
ååQ S
)
ååS T
;
ååT U
txt
çç( +
.
çç+ ,
Span
çç, 0
(
çç0 1
objeto
çç1 7
.
çç7 8
Cliente
çç8 ?
.
çç? @
Nombre
çç@ F
)
ççF G
.
ççG H
FontSize
ççH P
(
ççP Q
$num
ççQ S
)
ççS T
;
ççT U
}
éé$ %
)
éé% &
;
éé& '
col
èè$ '
.
èè' (
Item
èè( ,
(
èè, -
)
èè- .
.
èè. /
Text
èè/ 3
(
èè3 4
txt
èè4 7
=>
èè8 :
{
êê$ %
txt
ëë( +
.
ëë+ ,
Span
ëë, 0
(
ëë0 1
$str
ëë1 =
)
ëë= >
.
ëë> ?
SemiBold
ëë? G
(
ëëG H
)
ëëH I
.
ëëI J
FontSize
ëëJ R
(
ëëR S
$num
ëëS U
)
ëëU V
;
ëëV W
txt
íí( +
.
íí+ ,
Span
íí, 0
(
íí0 1
objeto
íí1 7
.
íí7 8
Cliente
íí8 ?
.
íí? @
Apellido
íí@ H
)
ííH I
.
ííI J
FontSize
ííJ R
(
ííR S
$num
ííS U
)
ííU V
;
ííV W
}
ìì$ %
)
ìì% &
;
ìì& '
}
îî  !
)
îî! "
;
îî" #
row
ïï  #
.
ïï# $
ConstantItem
ïï$ 0
(
ïï0 1
$num
ïï1 3
)
ïï3 4
;
ïï4 5
row
ññ  #
.
ññ# $
RelativeItem
ññ$ 0
(
ññ0 1
)
ññ1 2
.
ññ2 3
Column
ññ3 9
(
ññ9 :
col
ññ: =
=>
ññ> @
{
óó  !
col
òò$ '
.
òò' (
Item
òò( ,
(
òò, -
)
òò- .
.
òò. /
Text
òò/ 3
(
òò3 4
txt
òò4 7
=>
òò8 :
{
ôô$ %
txt
öö( +
.
öö+ ,
Span
öö, 0
(
öö0 1
$str
öö1 ;
)
öö; <
.
öö< =
SemiBold
öö= E
(
ööE F
)
ööF G
.
ööG H
FontSize
ööH P
(
ööP Q
$num
ööQ S
)
ööS T
;
ööT U
txt
õõ( +
.
õõ+ ,
Span
õõ, 0
(
õõ0 1
objeto
õõ1 7
.
õõ7 8
Cliente
õõ8 ?
.
õõ? @
Correo
õõ@ F
)
õõF G
.
õõG H
FontSize
õõH P
(
õõP Q
$num
õõQ S
)
õõS T
;
õõT U
}
úú$ %
)
úú% &
;
úú& '
col
ùù$ '
.
ùù' (
Item
ùù( ,
(
ùù, -
)
ùù- .
.
ùù. /
Text
ùù/ 3
(
ùù3 4
txt
ùù4 7
=>
ùù8 :
{
ûû$ %
txt
üü( +
.
üü+ ,
Span
üü, 0
(
üü0 1
$str
üü1 =
)
üü= >
.
üü> ?
SemiBold
üü? G
(
üüG H
)
üüH I
.
üüI J
FontSize
üüJ R
(
üüR S
$num
üüS U
)
üüU V
;
üüV W
txt
††( +
.
††+ ,
Span
††, 0
(
††0 1
objeto
††1 7
.
††7 8
Cliente
††8 ?
.
††? @
Telefono
††@ H
)
††H I
.
††I J
FontSize
††J R
(
††R S
$num
††S U
)
††U V
;
††V W
}
°°$ %
)
°°% &
;
°°& '
}
¢¢  !
)
¢¢! "
;
¢¢" #
}
££ 
)
££ 
;
££ 
}
§§ 
)
§§ 
;
§§ 
col1
¶¶ 
.
¶¶ 
Item
¶¶ !
(
¶¶! "
)
¶¶" #
.
¶¶# $
Column
¶¶$ *
(
¶¶* +
col2
¶¶+ /
=>
¶¶0 2
{
ßß 
col2
®®  
.
®®  !
Spacing
®®! (
(
®®( )
$num
®®) *
)
®®* +
;
®®+ ,
col2
©©  
.
©©  !
Item
©©! %
(
©©% &
)
©©& '
.
©©' (
Row
©©( +
(
©©+ ,
row
©©, /
=>
©©0 2
{
™™ 
row
´´  #
.
´´# $
RelativeItem
´´$ 0
(
´´0 1
)
´´1 2
.
´´2 3
BorderBottom
´´3 ?
(
´´? @
$num
´´@ A
)
´´A B
.
´´B C
	AlignLeft
´´C L
(
´´L M
)
´´M N
.
´´N O
Text
´´O S
(
´´S T
$str
´´T h
)
´´h i
.
´´i j
Bold
´´j n
(
´´n o
)
´´o p
.
´´p q
FontSize
´´q y
(
´´y z
$num
´´z |
)
´´| }
;
´´} ~
}
¨¨ 
)
¨¨ 
;
¨¨ 
col2
ÆÆ  
.
ÆÆ  !
Item
ÆÆ! %
(
ÆÆ% &
)
ÆÆ& '
.
ÆÆ' (
Row
ÆÆ( +
(
ÆÆ+ ,
row
ÆÆ, /
=>
ÆÆ0 2
{
ØØ 
row
∞∞  #
.
∞∞# $
RelativeItem
∞∞$ 0
(
∞∞0 1
)
∞∞1 2
.
∞∞2 3
Column
∞∞3 9
(
∞∞9 :
col
∞∞: =
=>
∞∞> @
{
±±  !
col
≤≤$ '
.
≤≤' (
Item
≤≤( ,
(
≤≤, -
)
≤≤- .
.
≤≤. /
Text
≤≤/ 3
(
≤≤3 4
txt
≤≤4 7
=>
≤≤8 :
{
≥≥$ %
txt
¥¥( +
.
¥¥+ ,
Span
¥¥, 0
(
¥¥0 1
$str
¥¥1 C
)
¥¥C D
.
¥¥D E
SemiBold
¥¥E M
(
¥¥M N
)
¥¥N O
.
¥¥O P
FontSize
¥¥P X
(
¥¥X Y
$num
¥¥Y [
)
¥¥[ \
;
¥¥\ ]
txt
µµ( +
.
µµ+ ,
Span
µµ, 0
(
µµ0 1
objeto
µµ1 7
.
µµ7 8
MontoPrestamo
µµ8 E
)
µµE F
.
µµF G
FontSize
µµG O
(
µµO P
$num
µµP R
)
µµR S
;
µµS T
}
∂∂$ %
)
∂∂% &
;
∂∂& '
col
∑∑$ '
.
∑∑' (
Item
∑∑( ,
(
∑∑, -
)
∑∑- .
.
∑∑. /
Text
∑∑/ 3
(
∑∑3 4
txt
∑∑4 7
=>
∑∑8 :
{
∏∏$ %
txt
ππ( +
.
ππ+ ,
Span
ππ, 0
(
ππ0 1
$str
ππ1 >
)
ππ> ?
.
ππ? @
SemiBold
ππ@ H
(
ππH I
)
ππI J
.
ππJ K
FontSize
ππK S
(
ππS T
$num
ππT V
)
ππV W
;
ππW X
txt
∫∫( +
.
∫∫+ ,
Span
∫∫, 0
(
∫∫0 1
objeto
∫∫1 7
.
∫∫7 8
InteresPorcentaje
∫∫8 I
)
∫∫I J
.
∫∫J K
FontSize
∫∫K S
(
∫∫S T
$num
∫∫T V
)
∫∫V W
;
∫∫W X
}
ªª$ %
)
ªª% &
;
ªª& '
col
ºº$ '
.
ºº' (
Item
ºº( ,
(
ºº, -
)
ºº- .
.
ºº. /
Text
ºº/ 3
(
ºº3 4
txt
ºº4 7
=>
ºº8 :
{
ΩΩ$ %
txt
ææ( +
.
ææ+ ,
Span
ææ, 0
(
ææ0 1
$str
ææ1 B
)
ææB C
.
ææC D
SemiBold
ææD L
(
ææL M
)
ææM N
.
ææN O
FontSize
ææO W
(
ææW X
$num
ææX Z
)
ææZ [
;
ææ[ \
txt
øø( +
.
øø+ ,
Span
øø, 0
(
øø0 1
objeto
øø1 7
.
øø7 8
	NroCuotas
øø8 A
.
øøA B
ToString
øøB J
(
øøJ K
)
øøK L
)
øøL M
.
øøM N
FontSize
øøN V
(
øøV W
$num
øøW Y
)
øøY Z
;
øøZ [
}
¿¿$ %
)
¿¿% &
;
¿¿& '
col
¡¡$ '
.
¡¡' (
Item
¡¡( ,
(
¡¡, -
)
¡¡- .
.
¡¡. /
Text
¡¡/ 3
(
¡¡3 4
txt
¡¡4 7
=>
¡¡8 :
{
¬¬$ %
txt
√√( +
.
√√+ ,
Span
√√, 0
(
√√0 1
$str
√√1 B
)
√√B C
.
√√C D
SemiBold
√√D L
(
√√L M
)
√√M N
.
√√N O
FontSize
√√O W
(
√√W X
$num
√√X Z
)
√√Z [
;
√√[ \
txt
ƒƒ( +
.
ƒƒ+ ,
Span
ƒƒ, 0
(
ƒƒ0 1
objeto
ƒƒ1 7
.
ƒƒ7 8
FormaDePago
ƒƒ8 C
)
ƒƒC D
.
ƒƒD E
FontSize
ƒƒE M
(
ƒƒM N
$num
ƒƒN P
)
ƒƒP Q
;
ƒƒQ R
}
≈≈$ %
)
≈≈% &
;
≈≈& '
col
∆∆$ '
.
∆∆' (
Item
∆∆( ,
(
∆∆, -
)
∆∆- .
.
∆∆. /
Text
∆∆/ 3
(
∆∆3 4
txt
∆∆4 7
=>
∆∆8 :
{
««$ %
txt
»»( +
.
»»+ ,
Span
»», 0
(
»»0 1
$str
»»1 @
)
»»@ A
.
»»A B
SemiBold
»»B J
(
»»J K
)
»»K L
.
»»L M
FontSize
»»M U
(
»»U V
$num
»»V X
)
»»X Y
;
»»Y Z
txt
……( +
.
……+ ,
Span
……, 0
(
……0 1
objeto
……1 7
.
……7 8
Moneda
……8 >
.
……> ?
Nombre
……? E
)
……E F
.
……F G
FontSize
……G O
(
……O P
$num
……P R
)
……R S
;
……S T
}
  $ %
)
  % &
;
  & '
}
ÀÀ  !
)
ÀÀ! "
;
ÀÀ" #
row
ÃÃ  #
.
ÃÃ# $
ConstantItem
ÃÃ$ 0
(
ÃÃ0 1
$num
ÃÃ1 3
)
ÃÃ3 4
;
ÃÃ4 5
row
ÕÕ  #
.
ÕÕ# $
RelativeItem
ÕÕ$ 0
(
ÕÕ0 1
)
ÕÕ1 2
.
ÕÕ2 3
Column
ÕÕ3 9
(
ÕÕ9 :
col
ÕÕ: =
=>
ÕÕ> @
{
ŒŒ  !
col
œœ$ '
.
œœ' (
Item
œœ( ,
(
œœ, -
)
œœ- .
.
œœ. /
Text
œœ/ 3
(
œœ3 4
txt
œœ4 7
=>
œœ8 :
{
––$ %
txt
——( +
.
——+ ,
Span
——, 0
(
——0 1
$str
——1 D
)
——D E
.
——E F
SemiBold
——F N
(
——N O
)
——O P
.
——P Q
FontSize
——Q Y
(
——Y Z
$num
——Z \
)
——\ ]
;
——] ^
txt
““( +
.
““+ ,
Span
““, 0
(
““0 1
objeto
““1 7
.
““7 8
ValorPorCuota
““8 E
)
““E F
.
““F G
FontSize
““G O
(
““O P
$num
““P R
)
““R S
;
““S T
}
””$ %
)
””% &
;
””& '
col
‘‘$ '
.
‘‘' (
Item
‘‘( ,
(
‘‘, -
)
‘‘- .
.
‘‘. /
Text
‘‘/ 3
(
‘‘3 4
txt
‘‘4 7
=>
‘‘8 :
{
’’$ %
txt
÷÷( +
.
÷÷+ ,
Span
÷÷, 0
(
÷÷0 1
$str
÷÷1 B
)
÷÷B C
.
÷÷C D
SemiBold
÷÷D L
(
÷÷L M
)
÷÷M N
.
÷÷N O
FontSize
÷÷O W
(
÷÷W X
$num
÷÷X Z
)
÷÷Z [
;
÷÷[ \
txt
◊◊( +
.
◊◊+ ,
Span
◊◊, 0
(
◊◊0 1
objeto
◊◊1 7
.
◊◊7 8
ValorInteres
◊◊8 D
)
◊◊D E
.
◊◊E F
FontSize
◊◊F N
(
◊◊N O
$num
◊◊O Q
)
◊◊Q R
;
◊◊R S
}
ÿÿ$ %
)
ÿÿ% &
;
ÿÿ& '
col
ŸŸ$ '
.
ŸŸ' (
Item
ŸŸ( ,
(
ŸŸ, -
)
ŸŸ- .
.
ŸŸ. /
Text
ŸŸ/ 3
(
ŸŸ3 4
txt
ŸŸ4 7
=>
ŸŸ8 :
{
⁄⁄$ %
txt
€€( +
.
€€+ ,
Span
€€, 0
(
€€0 1
$str
€€1 @
)
€€@ A
.
€€A B
SemiBold
€€B J
(
€€J K
)
€€K L
.
€€L M
FontSize
€€M U
(
€€U V
$num
€€V X
)
€€X Y
;
€€Y Z
txt
‹‹( +
.
‹‹+ ,
Span
‹‹, 0
(
‹‹0 1
objeto
‹‹1 7
.
‹‹7 8

ValorTotal
‹‹8 B
)
‹‹B C
.
‹‹C D
FontSize
‹‹D L
(
‹‹L M
$num
‹‹M O
)
‹‹O P
;
‹‹P Q
}
››$ %
)
››% &
;
››& '
}
ﬁﬁ  !
)
ﬁﬁ! "
;
ﬁﬁ" #
}
ﬂﬂ 
)
ﬂﬂ 
;
ﬂﬂ 
}
‡‡ 
)
‡‡ 
;
‡‡ 
col1
„„ 
.
„„ 
Item
„„ !
(
„„! "
)
„„" #
.
„„# $
Column
„„$ *
(
„„* +
col2
„„+ /
=>
„„0 2
{
‰‰ 
col2
ÂÂ  
.
ÂÂ  !
Spacing
ÂÂ! (
(
ÂÂ( )
$num
ÂÂ) *
)
ÂÂ* +
;
ÂÂ+ ,
col2
ÊÊ  
.
ÊÊ  !
Item
ÊÊ! %
(
ÊÊ% &
)
ÊÊ& '
.
ÊÊ' (
Row
ÊÊ( +
(
ÊÊ+ ,
row
ÊÊ, /
=>
ÊÊ0 2
{
ÁÁ 
row
ËË  #
.
ËË# $
RelativeItem
ËË$ 0
(
ËË0 1
)
ËË1 2
.
ËË2 3
BorderBottom
ËË3 ?
(
ËË? @
$num
ËË@ A
)
ËËA B
.
ËËB C
	AlignLeft
ËËC L
(
ËËL M
)
ËËM N
.
ËËN O
Text
ËËO S
(
ËËS T
$str
ËËT d
)
ËËd e
.
ËËe f
Bold
ËËf j
(
ËËj k
)
ËËk l
.
ËËl m
FontSize
ËËm u
(
ËËu v
$num
ËËv x
)
ËËx y
;
ËËy z
}
ÈÈ 
)
ÈÈ 
;
ÈÈ 
col2
ÍÍ  
.
ÍÍ  !
Item
ÍÍ! %
(
ÍÍ% &
)
ÍÍ& '
.
ÍÍ' (
Table
ÍÍ( -
(
ÍÍ- .
tabla
ÍÍ. 3
=>
ÍÍ4 6
{
ÎÎ 
tabla
ÏÏ  %
.
ÏÏ% &
ColumnsDefinition
ÏÏ& 7
(
ÏÏ7 8
columns
ÏÏ8 ?
=>
ÏÏ@ B
{
ÌÌ  !
columns
ÓÓ$ +
.
ÓÓ+ ,
RelativeColumn
ÓÓ, :
(
ÓÓ: ;
$num
ÓÓ; <
)
ÓÓ< =
;
ÓÓ= >
columns
ÔÔ$ +
.
ÔÔ+ ,
RelativeColumn
ÔÔ, :
(
ÔÔ: ;
)
ÔÔ; <
;
ÔÔ< =
columns
$ +
.
+ ,
RelativeColumn
, :
(
: ;
)
; <
;
< =
columns
ÒÒ$ +
.
ÒÒ+ ,
RelativeColumn
ÒÒ, :
(
ÒÒ: ;
)
ÒÒ; <
;
ÒÒ< =
}
ÛÛ  !
)
ÛÛ! "
;
ÛÛ" #
tabla
ıı  %
.
ıı% &
Header
ıı& ,
(
ıı, -
header
ıı- 3
=>
ıı4 6
{
ˆˆ  !
header
˜˜$ *
.
˜˜* +
Cell
˜˜+ /
(
˜˜/ 0
)
˜˜0 1
.
˜˜1 2

Background
˜˜2 <
(
˜˜< =
$str
˜˜= F
)
˜˜F G
.
¯¯$ %
Padding
¯¯% ,
(
¯¯, -
$num
¯¯- .
)
¯¯. /
.
¯¯/ 0
Text
¯¯0 4
(
¯¯4 5
$str
¯¯5 A
)
¯¯A B
.
¯¯B C
	FontColor
¯¯C L
(
¯¯L M
$str
¯¯M S
)
¯¯S T
;
¯¯T U
header
˙˙$ *
.
˙˙* +
Cell
˙˙+ /
(
˙˙/ 0
)
˙˙0 1
.
˙˙1 2

Background
˙˙2 <
(
˙˙< =
$str
˙˙= F
)
˙˙F G
.
˚˚# $
Padding
˚˚$ +
(
˚˚+ ,
$num
˚˚, -
)
˚˚- .
.
˚˚. /
Text
˚˚/ 3
(
˚˚3 4
$str
˚˚4 C
)
˚˚C D
.
˚˚D E
	FontColor
˚˚E N
(
˚˚N O
$str
˚˚O U
)
˚˚U V
;
˚˚V W
header
˝˝$ *
.
˝˝* +
Cell
˝˝+ /
(
˝˝/ 0
)
˝˝0 1
.
˝˝1 2

Background
˝˝2 <
(
˝˝< =
$str
˝˝= F
)
˝˝F G
.
˛˛# $
Padding
˛˛$ +
(
˛˛+ ,
$num
˛˛, -
)
˛˛- .
.
˛˛. /
Text
˛˛/ 3
(
˛˛3 4
$str
˛˛4 C
)
˛˛C D
.
˛˛D E
	FontColor
˛˛E N
(
˛˛N O
$str
˛˛O U
)
˛˛U V
;
˛˛V W
header
ÄÄ$ *
.
ÄÄ* +
Cell
ÄÄ+ /
(
ÄÄ/ 0
)
ÄÄ0 1
.
ÄÄ1 2

Background
ÄÄ2 <
(
ÄÄ< =
$str
ÄÄ= F
)
ÄÄF G
.
ÅÅ# $
Padding
ÅÅ$ +
(
ÅÅ+ ,
$num
ÅÅ, -
)
ÅÅ- .
.
ÅÅ. /
Text
ÅÅ/ 3
(
ÅÅ3 4
$str
ÅÅ4 <
)
ÅÅ< =
.
ÅÅ= >
	FontColor
ÅÅ> G
(
ÅÅG H
$str
ÅÅH N
)
ÅÅN O
;
ÅÅO P
}
ÇÇ  !
)
ÇÇ! "
;
ÇÇ" #
foreach
ÑÑ  '
(
ÑÑ( )
var
ÑÑ) ,
item
ÑÑ- 1
in
ÑÑ2 4
objeto
ÑÑ5 ;
.
ÑÑ; <
PrestamoDetalle
ÑÑ< K
)
ÑÑK L
{
ÖÖ  !
tabla
àà$ )
.
àà) *
Cell
àà* .
(
àà. /
)
àà/ 0
.
àà0 1
Border
àà1 7
(
àà7 8
$num
àà8 <
)
àà< =
.
àà= >
BorderColor
àà> I
(
ààI J
$str
ààJ S
)
ààS T
.
ââ( )
Padding
ââ) 0
(
ââ0 1
$num
ââ1 2
)
ââ2 3
.
ââ3 4
Text
ââ4 8
(
ââ8 9
item
ââ9 =
.
ââ= >
NroCuota
ââ> F
.
ââF G
ToString
ââG O
(
ââO P
)
ââP Q
)
ââQ R
.
ââR S
FontSize
ââS [
(
ââ[ \
$num
ââ\ ^
)
ââ^ _
;
ââ_ `
tabla
ãã$ )
.
ãã) *
Cell
ãã* .
(
ãã. /
)
ãã/ 0
.
ãã0 1
Border
ãã1 7
(
ãã7 8
$num
ãã8 <
)
ãã< =
.
ãã= >
BorderColor
ãã> I
(
ããI J
$str
ããJ S
)
ããS T
.
åå% &
Padding
åå& -
(
åå- .
$num
åå. /
)
åå/ 0
.
åå0 1
Text
åå1 5
(
åå5 6
item
åå6 :
.
åå: ;
	FechaPago
åå; D
)
ååD E
.
ååE F
FontSize
ååF N
(
ååN O
$num
ååO Q
)
ååQ R
;
ååR S
tabla
éé$ )
.
éé) *
Cell
éé* .
(
éé. /
)
éé/ 0
.
éé0 1
Border
éé1 7
(
éé7 8
$num
éé8 <
)
éé< =
.
éé= >
BorderColor
éé> I
(
ééI J
$str
ééJ S
)
ééS T
.
èè% &
Padding
èè& -
(
èè- .
$num
èè. /
)
èè/ 0
.
èè0 1
Text
èè1 5
(
èè5 6
$"
èè6 8
{
èè8 9
objeto
èè9 ?
.
èè? @
Moneda
èè@ F
.
èèF G
Simbolo
èèG N
}
èèN O
$str
èèO P
{
èèP Q
item
èèQ U
.
èèU V

MontoCuota
èèV `
}
èè` a
"
èèa b
)
èèb c
.
èèc d
FontSize
èèd l
(
èèl m
$num
èèm o
)
èèo p
;
èèp q
tabla
ëë$ )
.
ëë) *
Cell
ëë* .
(
ëë. /
)
ëë/ 0
.
ëë0 1
Border
ëë1 7
(
ëë7 8
$num
ëë8 <
)
ëë< =
.
ëë= >
BorderColor
ëë> I
(
ëëI J
$str
ëëJ S
)
ëëS T
.
íí% &
Padding
íí& -
(
íí- .
$num
íí. /
)
íí/ 0
.
íí0 1

AlignRight
íí1 ;
(
íí; <
)
íí< =
.
íí= >
Text
íí> B
(
ííB C
$"
ííC E
{
ííE F
item
ííF J
.
ííJ K
Estado
ííK Q
}
ííQ R
"
ííR S
)
ííS T
.
ííT U
FontSize
ííU ]
(
íí] ^
$num
íí^ `
)
íí` a
;
íía b
}
ìì  !
}
ïï 
)
ïï 
;
ïï 
}
ññ 
)
ññ 
;
ññ 
}
òò 
)
òò 
;
òò 
page
õõ 
.
õõ 
Footer
õõ 
(
õõ  
)
õõ  !
.
úú 

AlignRight
úú 
(
úú  
)
úú  !
.
ùù 
Text
ùù 
(
ùù 
txt
ùù 
=>
ùù  
{
ûû 
txt
üü 
.
üü 
Span
üü  
(
üü  !
$str
üü! *
)
üü* +
.
üü+ ,
FontSize
üü, 4
(
üü4 5
$num
üü5 7
)
üü7 8
;
üü8 9
txt
†† 
.
†† 
CurrentPageNumber
†† -
(
††- .
)
††. /
.
††/ 0
FontSize
††0 8
(
††8 9
$num
††9 ;
)
††; <
;
††< =
txt
°° 
.
°° 
Span
°°  
(
°°  !
$str
°°! '
)
°°' (
.
°°( )
FontSize
°°) 1
(
°°1 2
$num
°°2 4
)
°°4 5
;
°°5 6
txt
¢¢ 
.
¢¢ 

TotalPages
¢¢ &
(
¢¢& '
)
¢¢' (
.
¢¢( )
FontSize
¢¢) 1
(
¢¢1 2
$num
¢¢2 4
)
¢¢4 5
;
¢¢5 6
}
££ 
)
££ 
;
££ 
}
§§ 
)
§§ 
;
§§ 
}
•• 
)
•• 
.
•• 
GeneratePdf
•• 
(
•• 
)
•• 
;
•• 
Stream
®® 
	pdfStream
®® 
=
®® 
new
®® "
MemoryStream
®®# /
(
®®/ 0
pdf
®®0 3
)
®®3 4
;
®®4 5
return
©© 
File
©© 
(
©© 
	pdfStream
©© !
,
©©! "
$str
©©# 4
)
©©4 5
;
©©5 6
}
™™ 	
}
´´ 
}¨¨ ƒ9
gC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\MonedaController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
MonedaController !
:" #

Controller$ .
{ 
private 
readonly 

MonedaData #
_monedaData$ /
;/ 0
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
MonedaController 
(  

MonedaData  *

monedaData+ 5
,5 6
AuditoriaService7 G
auditoriaServiceH X
)X Y
{ 	
_monedaData 
= 

monedaData $
;$ %
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[ 	
HttpGet	 
] 
[ 	
	Authorize	 
( 
Roles 
= 
$str *
)* +
]+ ,
public 
async 
Task 
< 
IActionResult '
>' (
Lista) .
(. /
)/ 0
{ 	
List   
<   
Moneda   
>   
lista   
=    
await  ! &
_monedaData  ' 2
.  2 3
Lista  3 8
(  8 9
)  9 :
;  : ;
await!! 
_auditoriaService!! #
.!!# $
RegistrarLog!!$ 0
(!!0 1
User!!1 5
.!!5 6
Identity!!6 >
.!!> ?
Name!!? C
,!!C D
$str!!E L
,!!L M
$str!!N x
)!!x y
;!!y z
return"" 

StatusCode"" 
("" 
StatusCodes"" )
."") *
Status200OK""* 5
,""5 6
new""7 :
{""; <
data""= A
=""B C
lista""D I
}""J K
)""K L
;""L M
}## 	
[%% 	
HttpPost%%	 
]%% 
[&& 	
	Authorize&&	 
(&& 
Roles&& 
=&& 
$str&& *
)&&* +
]&&+ ,
public'' 
async'' 
Task'' 
<'' 
IActionResult'' '
>''' (
Crear'') .
(''. /
[''/ 0
FromBody''0 8
]''8 9
Moneda'': @
objeto''A G
)''G H
{(( 	
if)) 
()) 
!)) 

ModelState)) 
.)) 
IsValid)) #
)))# $
{** 
return++ 

BadRequest++ !
(++! "

ModelState++" ,
)++, -
;++- .
},, 
string-- 
	respuesta-- 
=-- 
await-- $
_monedaData--% 0
.--0 1
Crear--1 6
(--6 7
objeto--7 =
)--= >
;--> ?
await.. 
_auditoriaService.. #
...# $
RegistrarLog..$ 0
(..0 1
User..1 5
...5 6
Identity..6 >
...> ?
Name..? C
,..C D
$str..E L
,..L M
$"..N P
$str..P _
{.._ `
objeto..` f
...f g
Nombre..g m
}..m n
"..n o
)..o p
;..p q
return// 

StatusCode// 
(// 
StatusCodes// )
.//) *
Status200OK//* 5
,//5 6
new//7 :
{//; <
data//= A
=//B C
	respuesta//D M
}//N O
)//O P
;//P Q
}00 	
[22 	
HttpPut22	 
]22 
[33 	
	Authorize33	 
(33 
Roles33 
=33 
$str33 *
)33* +
]33+ ,
public44 
async44 
Task44 
<44 
IActionResult44 '
>44' (
Editar44) /
(44/ 0
[440 1
FromBody441 9
]449 :
Moneda44; A
objeto44B H
)44H I
{55 	
if66 
(66 
!66 

ModelState66 
.66 
IsValid66 #
)66# $
{77 
return88 

BadRequest88 !
(88! "

ModelState88" ,
)88, -
;88- .
}99 
string:: 
	respuesta:: 
=:: 
await:: $
_monedaData::% 0
.::0 1
Editar::1 7
(::7 8
objeto::8 >
)::> ?
;::? @
await;; 
_auditoriaService;; #
.;;# $
RegistrarLog;;$ 0
(;;0 1
User;;1 5
.;;5 6
Identity;;6 >
.;;> ?
Name;;? C
!;;C D
,;;D E
$str;;F N
,;;N O
$";;P R
$str;;R b
{;;b c
objeto;;c i
.;;i j
Nombre;;j p
};;p q
";;q r
);;r s
;;;s t
return<< 

StatusCode<< 
(<< 
StatusCodes<< )
.<<) *
Status200OK<<* 5
,<<5 6
new<<7 :
{<<; <
data<<= A
=<<B C
	respuesta<<D M
}<<N O
)<<O P
;<<P Q
}== 	
[?? 	

HttpDelete??	 
]?? 
[@@ 	
	Authorize@@	 
(@@ 
Roles@@ 
=@@ 
$str@@ *
)@@* +
]@@+ ,
publicAA 
asyncAA 
TaskAA 
<AA 
IActionResultAA '
>AA' (
EliminarAA) 1
(AA1 2
intAA2 5
IdAA6 8
)AA8 9
{BB 	
ifCC 
(CC 
!CC 

ModelStateCC 
.CC 
IsValidCC #
)CC# $
{DD 
returnEE 

BadRequestEE !
(EE! "

ModelStateEE" ,
)EE, -
;EE- .
}FF 
stringGG 
	respuestaGG 
=GG 
awaitGG $
_monedaDataGG% 0
.GG0 1
EliminarGG1 9
(GG9 :
IdGG: <
)GG< =
;GG= >
awaitHH 
_auditoriaServiceHH #
.HH# $
RegistrarLogHH$ 0
(HH0 1
UserHH1 5
.HH5 6
IdentityHH6 >
.HH> ?
NameHH? C
,HHC D
$strHHE O
,HHO P
$"HHQ S
$strHHS l
{HHl m
IdHHm o
}HHo p
"HHp q
)HHq r
;HHr s
returnII 

StatusCodeII 
(II 
StatusCodesII )
.II) *
Status200OKII* 5
,II5 6
newII7 :
{II; <
dataII= A
=IIB C
	respuestaIID M
}IIN O
)IIO P
;IIP Q
}JJ 	
}KK 
}LL Â™
fC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\LoginController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
public 

class 
LoginController  
:! "

Controller# -
{ 
private 
readonly 
UsuarioData $
_usuarioData% 1
;1 2
private 
readonly 
EmailService %
_emailService& 3
;3 4
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
LoginController 
( 
UsuarioData *
usuarioData+ 6
,6 7
EmailService8 D
emailServiceE Q
,Q R
IConfigurationS a
configurationb o
,o p
AuditoriaService	q Å
auditoriaService
Ç í
)
í ì
{ 	
_usuarioData 
= 
usuarioData &
;& '
_emailService 
= 
emailService (
;( )
_configuration   
=   
configuration   *
;  * +
_auditoriaService!! 
=!! 
auditoriaService!!  0
;!!0 1
}"" 	
public## 
IActionResult## 
Index## "
(##" #
)### $
{$$ 	
return%% 
View%% 
(%% 
)%% 
;%% 
}&& 	
[(( 	
HttpPost((	 
](( 
public)) 
async)) 
Task)) 
<)) 
IActionResult)) '
>))' (
Index))) .
()). /
string))/ 5
correo))6 <
,))< =
string))> D
clave))E J
)))J K
{** 	
if++ 
(++ 
string++ 
.++ 
IsNullOrEmpty++ $
(++$ %
correo++% +
)+++ ,
||++- /
string++0 6
.++6 7
IsNullOrEmpty++7 D
(++D E
clave++E J
)++J K
)++K L
{,, 
ViewData-- 
[-- 
$str-- "
]--" #
=--$ %
$str--& I
;--I J
return.. 
View.. 
(.. 
).. 
;.. 
}// 
var22 
usuario22 
=22 
await22 
_usuarioData22  ,
.22, -
ObtenerPorCorreo22- =
(22= >
correo22> D
)22D E
;22E F
if33 
(33 
usuario33 
==33 
null33 
)33  
{44 
ViewData55 
[55 
$str55 "
]55" #
=55$ %
$str55& =
;55= >
return66 
View66 
(66 
)66 
;66 
}77 
if:: 
(:: 
usuario:: 
.:: 
IsLocked::  
)::  !
{;; 
if<< 
(<< 
usuario<< 
.<< 

LockoutEnd<< &
><<' (
DateTime<<) 1
.<<1 2
UtcNow<<2 8
)<<8 9
{== 
ViewData>> 
[>> 
$str>> &
]>>& '
=>>( )
$str>>* k
;>>k l
return?? 
View?? 
(??  
)??  !
;??! "
}@@ 
elseAA 
{BB 
awaitDD 
_usuarioDataDD &
.DD& '
ResetLockoutDD' 3
(DD3 4
usuarioDD4 ;
.DD; <
	IdUsuarioDD< E
)DDE F
;DDF G
}EE 
}FF 
ifII 
(II 
usuarioII 
.II 

LockoutEndII "
!=II# %
nullII& *
&&II+ -
usuarioII. 5
.II5 6

LockoutEndII6 @
>IIA B
DateTimeIIC K
.IIK L
UtcNowIIL R
)IIR S
{JJ 
varKK 
tiempoRestanteKK "
=KK# $
(KK% &
usuarioKK& -
.KK- .

LockoutEndKK. 8
.KK8 9
ValueKK9 >
-KK? @
DateTimeKKA I
.KKI J
UtcNowKKJ P
)KKP Q
.KKQ R
TotalSecondsKKR ^
;KK^ _
ConsoleLL 
.LL 
	WriteLineLL !
(LL! "
$"LL" $
$strLL$ 5
{LL5 6
tiempoRestanteLL6 D
}LLD E
"LLE F
)LLF G
;LLG H
ifNN 
(NN 
tiempoRestanteNN "
>NN# $
$numNN% &
)NN& '
{OO 
ViewDataPP 
[PP 
$strPP &
]PP& '
=PP( )
$"PP* ,
$strPP, =
{PP= >
(PP> ?
intPP? B
)PPB C
tiempoRestantePPC Q
}PPQ R
$strPPR y
"PPy z
;PPz {
ViewDataQQ 
[QQ 
$strQQ .
]QQ. /
=QQ0 1
(QQ2 3
intQQ3 6
)QQ6 7
MathQQ7 ;
.QQ; <
CeilingQQ< C
(QQC D
tiempoRestanteQQD R
)QQR S
;QQS T
ConsoleRR 
.RR 
	WriteLineRR %
(RR% &
$"RR& (
$strRR( :
{RR: ;
tiempoRestanteRR; I
}RRI J
"RRJ K
)RRK L
;RRL M
ConsoleSS 
.SS 
	WriteLineSS %
(SS% &
ViewDataSS& .
[SS. /
$strSS/ @
]SS@ A
)SSA B
;SSB C
returnTT 
ViewTT 
(TT  
)TT  !
;TT! "
}UU 
elseVV 
{WW 
ViewDataXX 
[XX 
$strXX .
]XX. /
=XX0 1
nullXX2 6
;XX6 7
}YY 
}ZZ 
if]] 
(]] 
string]] 
.]] 
IsNullOrEmpty]] $
(]]$ %
usuario]]% ,
.]], -
Clave]]- 2
)]]2 3
)]]3 4
{^^ 
ViewData__ 
[__ 
$str__ "
]__" #
=__$ %
$str__& T
;__T U
return`` 
View`` 
(`` 
)`` 
;`` 
}aa 
boolcc 
isPasswordValidcc  
=cc! "
BCryptcc# )
.cc) *
Netcc* -
.cc- .
BCryptcc. 4
.cc4 5
Verifycc5 ;
(cc; <
clavecc< A
,ccA B
usuarioccC J
.ccJ K
ClaveccK P
)ccP Q
;ccQ R
ifee 
(ee 
!ee 
isPasswordValidee  
)ee  !
{ff 
usuariogg 
.gg 
FailedAttemptsgg &
++gg& (
;gg( )
usuariohh 
.hh 
LastFailedAttempthh )
=hh* +
DateTimehh, 4
.hh4 5
UtcNowhh5 ;
;hh; <
intjj 
tiempoBloqueadojj #
=jj$ %
$numjj& '
;jj' (
ifkk 
(kk 
usuariokk 
.kk 
FailedAttemptskk *
==kk+ -
$numkk. /
)kk/ 0
{ll 
tiempoBloqueadomm #
=mm$ %
$nummm& (
;mm( )
usuarionn 
.nn 

LockoutEndnn &
=nn' (
DateTimenn) 1
.nn1 2
UtcNownn2 8
.nn8 9

AddSecondsnn9 C
(nnC D
tiempoBloqueadonnD S
)nnS T
;nnT U
}oo 
elsepp 
ifpp 
(pp 
usuariopp  
.pp  !
FailedAttemptspp! /
==pp0 2
$numpp3 4
)pp4 5
{qq 
tiempoBloqueadorr #
=rr$ %
$numrr& (
;rr( )
usuarioss 
.ss 

LockoutEndss &
=ss' (
DateTimess) 1
.ss1 2
UtcNowss2 8
.ss8 9

AddSecondsss9 C
(ssC D
tiempoBloqueadossD S
)ssS T
;ssT U
}tt 
elseuu 
ifuu 
(uu 
usuariouu  
.uu  !
FailedAttemptsuu! /
>=uu0 2
$numuu3 4
)uu4 5
{vv 
usuarioww 
.ww 
IsLockedww $
=ww% &
trueww' +
;ww+ ,
usuarioxx 
.xx 

LockoutEndxx &
=xx' (
DateTimexx) 1
.xx1 2
MaxValuexx2 :
;xx: ;
awaityy 
_usuarioDatayy &
.yy& '
UpdateLockoutStatusyy' :
(yy: ;
usuarioyy; B
)yyB C
;yyC D
ViewDatazz 
[zz 
$strzz &
]zz& '
=zz( )
$strzz* s
;zzs t
return{{ 
View{{ 
({{  
){{  !
;{{! "
}|| 
await~~ 
_usuarioData~~ "
.~~" #
UpdateLockoutStatus~~# 6
(~~6 7
usuario~~7 >
)~~> ?
;~~? @
if
ÄÄ 
(
ÄÄ 
tiempoBloqueado
ÄÄ #
>
ÄÄ$ %
$num
ÄÄ& '
)
ÄÄ' (
{
ÅÅ 
ViewData
ÇÇ 
[
ÇÇ 
$str
ÇÇ &
]
ÇÇ& '
=
ÇÇ( )
$str
ÇÇ* q
;
ÇÇq r
ViewData
ÉÉ 
[
ÉÉ 
$str
ÉÉ .
]
ÉÉ. /
=
ÉÉ0 1
tiempoBloqueado
ÉÉ2 A
;
ÉÉA B
return
ÑÑ 
View
ÑÑ 
(
ÑÑ  
)
ÑÑ  !
;
ÑÑ! "
}
ÖÖ 
ViewData
áá 
[
áá 
$str
áá "
]
áá" #
=
áá$ %
$"
áá& (
$str
áá( S
{
ááS T
$num
ááT U
-
ááV W
usuario
ááX _
.
áá_ `
FailedAttempts
áá` n
}
áán o
"
ááo p
;
ááp q
return
àà 
View
àà 
(
àà 
)
àà 
;
àà 
}
ââ 
await
åå 
_usuarioData
åå 
.
åå 
ResetLockout
åå +
(
åå+ ,
usuario
åå, 3
.
åå3 4
	IdUsuario
åå4 =
)
åå= >
;
åå> ?
var
èè  
codigoVerificacion
èè "
=
èè# $'
GenerarCodigoVerificacion
èè% >
(
èè> ?
)
èè? @
;
èè@ A
HttpContext
êê 
.
êê 
Session
êê 
.
êê  
	SetString
êê  )
(
êê) *
$str
êê* >
,
êê> ? 
codigoVerificacion
êê@ R
)
êêR S
;
êêS T
HttpContext
ëë 
.
ëë 
Session
ëë 
.
ëë  
	SetString
ëë  )
(
ëë) *
$str
ëë* >
,
ëë> ?
correo
ëë@ F
)
ëëF G
;
ëëG H
string
îî 
asunto
îî 
=
îî 
$str
îî 4
;
îî4 5
string
ïï 
mensaje
ïï 
=
ïï 
$"
ïï 
$str
ïï =
{
ïï= > 
codigoVerificacion
ïï> P
}
ïïP Q
"
ïïQ R
;
ïïR S
await
ññ 
_emailService
ññ 
.
ññ  
EnviarCorreoAsync
ññ  1
(
ññ1 2
correo
ññ2 8
,
ññ8 9
asunto
ññ: @
,
ññ@ A
mensaje
ññB I
)
ññI J
;
ññJ K
var
ôô 
claims
ôô 
=
ôô 
new
ôô 
[
ôô 
]
ôô 
{
öö 
new
õõ 
Claim
õõ 
(
õõ 

ClaimTypes
õõ $
.
õõ$ %
Name
õõ% )
,
õõ) *
usuario
õõ+ 2
.
õõ2 3
NombreCompleto
õõ3 A
)
õõA B
,
õõB C
new
úú 
Claim
úú 
(
úú 

ClaimTypes
úú $
.
úú$ %
NameIdentifier
úú% 3
,
úú3 4
usuario
úú5 <
.
úú< =
	IdUsuario
úú= F
.
úúF G
ToString
úúG O
(
úúO P
)
úúP Q
)
úúQ R
,
úúR S
new
ùù 
Claim
ùù 
(
ùù 

ClaimTypes
ùù $
.
ùù$ %
Email
ùù% *
,
ùù* +
usuario
ùù, 3
.
ùù3 4
Correo
ùù4 :
)
ùù: ;
,
ùù; <
new
ûû 
Claim
ûû 
(
ûû 

ClaimTypes
ûû $
.
ûû$ %
Role
ûû% )
,
ûû) *
usuario
ûû+ 2
.
ûû2 3
Rol
ûû3 6
)
ûû6 7
}
üü 
;
üü 
var
°° 
key
°° 
=
°° 
new
°° "
SymmetricSecurityKey
°° .
(
°°. /
Encoding
°°/ 7
.
°°7 8
UTF8
°°8 <
.
°°< =
GetBytes
°°= E
(
°°E F
_configuration
°°F T
[
°°T U
$str
°°U ^
]
°°^ _
!
°°_ `
)
°°` a
)
°°a b
;
°°b c
var
¢¢ 
credentials
¢¢ 
=
¢¢ 
new
¢¢ ! 
SigningCredentials
¢¢" 4
(
¢¢4 5
key
¢¢5 8
,
¢¢8 9 
SecurityAlgorithms
¢¢: L
.
¢¢L M

HmacSha256
¢¢M W
)
¢¢W X
;
¢¢X Y
var
££ 
expires
££ 
=
££ 
DateTime
££ "
.
££" #
Now
££# &
.
££& '

AddMinutes
££' 1
(
££1 2
Convert
££2 9
.
££9 :
ToDouble
££: B
(
££B C
_configuration
££C Q
[
££Q R
$str
££R _
]
££_ `
)
££` a
)
££a b
;
££b c
var
•• 
token
•• 
=
•• 
new
•• 
JwtSecurityToken
•• ,
(
••, -
_configuration
¶¶ 
[
¶¶ 
$str
¶¶ +
]
¶¶+ ,
,
¶¶, -
_configuration
ßß 
[
ßß 
$str
ßß -
]
ßß- .
,
ßß. /
claims
®® 
,
®® 
expires
©© 
:
©© 
expires
©©  
,
©©  ! 
signingCredentials
™™ "
:
™™" #
credentials
™™$ /
)
´´ 
;
´´ 
HttpContext
≠≠ 
.
≠≠ 
Session
≠≠ 
.
≠≠  
	SetString
≠≠  )
(
≠≠) *
$str
≠≠* 1
,
≠≠1 2
new
≠≠3 6%
JwtSecurityTokenHandler
≠≠7 N
(
≠≠N O
)
≠≠O P
.
≠≠P Q

WriteToken
≠≠Q [
(
≠≠[ \
token
≠≠\ a
)
≠≠a b
)
≠≠b c
;
≠≠c d
TempData
ÆÆ 
[
ÆÆ 
$str
ÆÆ 
]
ÆÆ 
=
ÆÆ 
new
ÆÆ  #%
JwtSecurityTokenHandler
ÆÆ$ ;
(
ÆÆ; <
)
ÆÆ< =
.
ÆÆ= >

WriteToken
ÆÆ> H
(
ÆÆH I
token
ÆÆI N
)
ÆÆN O
;
ÆÆO P
return
ØØ 
RedirectToAction
ØØ #
(
ØØ# $
$str
ØØ$ 5
)
ØØ5 6
;
ØØ6 7
}
∞∞ 	
public
≤≤ 
IActionResult
≤≤ 
VerificarCodigo
≤≤ ,
(
≤≤, -
)
≤≤- .
{
≥≥ 	
ViewData
¥¥ 
[
¥¥ 
$str
¥¥ 
]
¥¥ 
=
¥¥ 
TempData
¥¥  (
[
¥¥( )
$str
¥¥) 0
]
¥¥0 1
;
¥¥1 2
return
µµ 
View
µµ 
(
µµ 
)
µµ 
;
µµ 
}
∂∂ 	
[
∏∏ 	
HttpPost
∏∏	 
]
∏∏ 
public
ππ 
async
ππ 
Task
ππ 
<
ππ 
IActionResult
ππ '
>
ππ' ("
VerificarCodigoAsync
ππ) =
(
ππ= >
string
ππ> D
codigo
ππE K
)
ππK L
{
∫∫ 	
var
ªª  
codigoVerificacion
ªª "
=
ªª# $
HttpContext
ªª% 0
.
ªª0 1
Session
ªª1 8
.
ªª8 9
	GetString
ªª9 B
(
ªªB C
$str
ªªC W
)
ªªW X
;
ªªX Y
var
ºº 
correo
ºº 
=
ºº 
HttpContext
ºº $
.
ºº$ %
Session
ºº% ,
.
ºº, -
	GetString
ºº- 6
(
ºº6 7
$str
ºº7 K
)
ººK L
;
ººL M
var
ΩΩ 
token
ΩΩ 
=
ΩΩ 
HttpContext
ΩΩ #
.
ΩΩ# $
Session
ΩΩ$ +
.
ΩΩ+ ,
	GetString
ΩΩ, 5
(
ΩΩ5 6
$str
ΩΩ6 =
)
ΩΩ= >
;
ΩΩ> ?
if
øø 
(
øø 
codigo
øø 
==
øø  
codigoVerificacion
øø ,
)
øø, -
{
¿¿ 
var
¡¡ 
usuario
¡¡ 
=
¡¡ 
_usuarioData
¡¡ *
.
¡¡* +
ObtenerPorCorreo
¡¡+ ;
(
¡¡; <
correo
¡¡< B
!
¡¡B C
)
¡¡C D
.
¡¡D E
Result
¡¡E K
;
¡¡K L
var
√√ 
claims
√√ 
=
√√ 
new
√√  
List
√√! %
<
√√% &
Claim
√√& +
>
√√+ ,
{
ƒƒ 
new
≈≈ 
Claim
≈≈ 
(
≈≈ 

ClaimTypes
≈≈ (
.
≈≈( )
Name
≈≈) -
,
≈≈- .
usuario
≈≈/ 6
.
≈≈6 7
NombreCompleto
≈≈7 E
)
≈≈E F
,
≈≈F G
new
∆∆ 
Claim
∆∆ 
(
∆∆ 

ClaimTypes
∆∆ (
.
∆∆( )
Email
∆∆) .
,
∆∆. /
usuario
∆∆0 7
.
∆∆7 8
Correo
∆∆8 >
)
∆∆> ?
,
∆∆? @
new
«« 
Claim
«« 
(
«« 

ClaimTypes
«« (
.
««( )
Role
««) -
,
««- .
usuario
««/ 6
.
««6 7
Rol
««7 :
)
««: ;
}
»» 
;
»» 
var
   
identity
   
=
   
new
   "
ClaimsIdentity
  # 1
(
  1 2
claims
  2 8
,
  8 9*
CookieAuthenticationDefaults
  : V
.
  V W"
AuthenticationScheme
  W k
)
  k l
;
  l m
var
ÀÀ 
	principal
ÀÀ 
=
ÀÀ 
new
ÀÀ  #
ClaimsPrincipal
ÀÀ$ 3
(
ÀÀ3 4
identity
ÀÀ4 <
)
ÀÀ< =
;
ÀÀ= >
await
ŒŒ 
HttpContext
ŒŒ !
.
ŒŒ! "
SignInAsync
ŒŒ" -
(
ŒŒ- .*
CookieAuthenticationDefaults
œœ 0
.
œœ0 1"
AuthenticationScheme
œœ1 E
,
œœE F
	principal
–– 
,
–– 
new
—— &
AuthenticationProperties
—— 0
{
——1 2
IsPersistent
——3 ?
=
——@ A
false
——B G
}
——H I
)
““ 
;
““ 
Response
’’ 
.
’’ 
Cookies
’’  
.
’’  !
Append
’’! '
(
’’' (
$str
’’( 6
,
’’6 7
token
’’8 =
!
’’= >
,
’’> ?
new
’’@ C
CookieOptions
’’D Q
{
÷÷ 
HttpOnly
◊◊ 
=
◊◊ 
true
◊◊ #
,
◊◊# $
Secure
ÿÿ 
=
ÿÿ 
true
ÿÿ !
}
ŸŸ 
)
ŸŸ 
;
ŸŸ 
TempData
⁄⁄ 
[
⁄⁄ 
$str
⁄⁄  
]
⁄⁄  !
=
⁄⁄" #
token
⁄⁄$ )
;
⁄⁄) *
await
€€ 
_auditoriaService
€€ '
.
€€' (
RegistrarLog
€€( 4
(
€€4 5
usuario
€€5 <
.
€€< =
Correo
€€= C
,
€€C D
$str
€€E W
,
€€W X
$str
€€Y s
)
€€s t
;
€€t u
return
‹‹ 
RedirectToAction
‹‹ '
(
‹‹' (
$str
‹‹( /
,
‹‹/ 0
$str
‹‹1 7
)
‹‹7 8
;
‹‹8 9
}
›› 
else
ﬁﬁ 
{
ﬂﬂ 
ViewData
‡‡ 
[
‡‡ 
$str
‡‡ "
]
‡‡" #
=
‡‡$ %
$str
‡‡& I
;
‡‡I J
return
·· 
View
·· 
(
·· 
)
·· 
;
·· 
}
‚‚ 
}
„„ 	
public
ÂÂ 
async
ÂÂ 
Task
ÂÂ 
<
ÂÂ 
IActionResult
ÂÂ '
>
ÂÂ' (
Salir
ÂÂ) .
(
ÂÂ. /
)
ÂÂ/ 0
{
ÊÊ 	
await
ÁÁ 
HttpContext
ÁÁ 
.
ÁÁ 
SignOutAsync
ÁÁ *
(
ÁÁ* +
JwtBearerDefaults
ÁÁ+ <
.
ÁÁ< ="
AuthenticationScheme
ÁÁ= Q
)
ÁÁQ R
;
ÁÁR S
return
ËË 
RedirectToAction
ËË #
(
ËË# $
$str
ËË$ +
,
ËË+ ,
$str
ËË- 4
)
ËË4 5
;
ËË5 6
}
ÈÈ 	
private
ÎÎ 
string
ÎÎ '
GenerarCodigoVerificacion
ÎÎ 0
(
ÎÎ0 1
)
ÎÎ1 2
{
ÏÏ 	
using
ÌÌ 
(
ÌÌ 
var
ÌÌ 
rng
ÌÌ 
=
ÌÌ #
RandomNumberGenerator
ÌÌ 2
.
ÌÌ2 3
Create
ÌÌ3 9
(
ÌÌ9 :
)
ÌÌ: ;
)
ÌÌ; <
{
ÓÓ 
var
ÔÔ 
bytes
ÔÔ 
=
ÔÔ 
new
ÔÔ 
byte
ÔÔ  $
[
ÔÔ$ %
$num
ÔÔ% &
]
ÔÔ& '
;
ÔÔ' (
rng
 
.
 
GetBytes
 
(
 
bytes
 "
)
" #
;
# $
return
ÒÒ 
BitConverter
ÒÒ #
.
ÒÒ# $
ToUInt32
ÒÒ$ ,
(
ÒÒ, -
bytes
ÒÒ- 2
,
ÒÒ2 3
$num
ÒÒ4 5
)
ÒÒ5 6
.
ÒÒ6 7
ToString
ÒÒ7 ?
(
ÒÒ? @
$str
ÒÒ@ D
)
ÒÒD E
;
ÒÒE F
}
ÚÚ 
}
ÛÛ 	
}
ÙÙ 
}ıı ÕP
eC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\HomeController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
HomeController 
:  !

Controller" ,
{ 
private 
readonly 
ILogger  
<  !
HomeController! /
>/ 0
_logger1 8
;8 9
private 
readonly 
ResumenData $
_resumenData% 1
;1 2
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 
ResumenClienteData +
_resumenClienteData, ?
;? @
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
HomeController 
( 
ILogger %
<% &
HomeController& 4
>4 5
logger6 <
,< =
ResumenData= H
resumenDataI T
,T U
ClienteDataV a
clienteDatab m
,m n
ResumenClienteData	o Å 
resumenClienteData
Ç î
,
î ï
PrestamoData
ñ ¢
prestamoData
£ Ø
,
Ø ∞
AuditoriaService
± ¡
auditoriaService
¬ “
)
“ ”
{ 	
_logger 
= 
logger 
; 
_resumenData 
= 
resumenData &
;& '
_clienteData 
= 
clienteData &
;& '
_resumenClienteData 
=  !
resumenClienteData" 4
;4 5
_prestamoData 
= 
prestamoData (
;( )
_auditoriaService   
=   
auditoriaService    0
;  0 1
}!! 	
public"" 
IActionResult"" 
Index"" "
(""" #
)""# $
{## 	
return$$ 
View$$ 
($$ 
)$$ 
;$$ 
}%% 	
public&& 
IActionResult&& 
Privacy&& $
(&&$ %
)&&% &
{'' 	
return(( 
View(( 
((( 
)(( 
;(( 
})) 	
[++ 	
ResponseCache++	 
(++ 
Duration++ 
=++  !
$num++" #
,++# $
Location++% -
=++. /!
ResponseCacheLocation++0 E
.++E F
None++F J
,++J K
NoStore++L S
=++T U
true++V Z
)++Z [
]++[ \
public,, 
IActionResult,, 
Error,, "
(,," #
),,# $
{-- 	
return.. 
View.. 
(.. 
new.. 
ErrorViewModel.. *
{..+ ,
	RequestId..- 6
=..7 8
Activity..9 A
...A B
Current..B I
?..I J
...J K
Id..K M
??..N P
HttpContext..Q \
...\ ]
TraceIdentifier..] l
}..m n
)..n o
;..o p
}// 	
[11 	
HttpGet11	 
]11 
[22 	
	Authorize22	 
(22 
Roles22 
=22 
$str22 *
)22* +
]22+ ,
public33 
async33 
Task33 
<33 
IActionResult33 '
>33' (
ObtenerResumen33) 7
(337 8
)338 9
{44 	
var66 
usuario66 
=66 
User66 
.66 
Identity66 '
!66' (
.66( )
Name66) -
;66- .
await77 
_auditoriaService77 #
.77# $
RegistrarLog77$ 0
(770 1
usuario771 8
!778 9
,779 :
$str77; K
,77K L
$str77M }
)77} ~
;77~ 
Resumen99 
objeto99 
=99 
await99 "
_resumenData99# /
.99/ 0
Obtener990 7
(997 8
)998 9
;999 :
return:: 

StatusCode:: 
(:: 
StatusCodes:: )
.::) *
Status200OK::* 5
,::5 6
new::7 :
{::; <
data::= A
=::B C
objeto::D J
}::K L
)::L M
;::M N
};; 	
[== 	
HttpGet==	 
]== 
public>> 
IActionResult>> 
ObtenerRolUsuario>> .
(>>. /
)>>/ 0
{?? 	
var@@ 
roles@@ 
=@@ 
User@@ 
.@@ 
Claims@@ #
.@@# $
Where@@$ )
(@@) *
c@@* +
=>@@, .
c@@/ 0
.@@0 1
Type@@1 5
==@@6 8

ClaimTypes@@9 C
.@@C D
Role@@D H
)@@H I
.@@I J
Select@@J P
(@@P Q
c@@Q R
=>@@S U
c@@V W
.@@W X
Value@@X ]
)@@] ^
.@@^ _
ToList@@_ e
(@@e f
)@@f g
;@@g h
returnAA 
OkAA 
(AA 
newAA 
{AA 
rolesAA !
}AA" #
)AA# $
;AA$ %
}BB 	
[DD 	
HttpGetDD	 
]DD 
publicEE 
asyncEE 
TaskEE 
<EE 
IActionResultEE '
>EE' (!
ObtenerResumenClienteEE) >
(EE> ?
intEE? B

idPrestamoEEC M
)EEM N
{FF 	
ifGG 
(GG 
!GG 

ModelStateGG 
.GG 
IsValidGG #
)GG# $
{HH 
returnII 

BadRequestII !
(II! "

ModelStateII" ,
)II, -
;II- .
}JJ 
varKK 
usuarioKK 
=KK 
UserKK 
.KK 
IdentityKK '
!KK' (
.KK( )
NameKK) -
;KK- .
awaitLL 
_auditoriaServiceLL #
.LL# $
RegistrarLogLL$ 0
(LL0 1
usuarioLL1 8
!LL8 9
,LL9 :
$strLL; R
,LLR S
$str	LLT Å
)
LLÅ Ç
;
LLÇ É
varNN 
correoNN 
=NN 
UserNN 
.NN 
	FindFirstNN '
(NN' (

ClaimTypesNN( 2
.NN2 3
EmailNN3 8
)NN8 9
?NN9 :
.NN: ;
ValueNN; @
;NN@ A
ConsoleOO 
.OO 
	WriteLineOO 
(OO 
correoOO $
)OO$ %
;OO% &
ifPP 
(PP 
stringPP 
.PP 
IsNullOrEmptyPP $
(PP$ %
correoPP% +
)PP+ ,
)PP, -
{QQ 
returnRR 
RedirectToActionRR '
(RR' (
$strRR( /
,RR/ 0
$strRR1 7
)RR7 8
;RR8 9
}SS 
varUU 
clienteUU 
=UU 
awaitUU 
_clienteDataUU  ,
.UU, -
ObtenerPorCorreoUU- =
(UU= >
correoUU> D
)UUD E
;UUE F
varVV 
prestamoVV 
=VV 
awaitVV  
_prestamoDataVV! .
.VV. /'
ObtenerIdPrestamoPorClienteVV/ J
(VVJ K
clienteVVK R
.VVR S
	IdClienteVVS \
)VV\ ]
;VV] ^
ConsoleWW 
.WW 
	WriteLineWW 
(WW 
prestamoWW &
)WW& '
;WW' (
ifXX 
(XX 
clienteXX 
!=XX 
nullXX 
)XX  
{YY 
varZZ 
resumenZZ 
=ZZ 
awaitZZ #
_resumenClienteDataZZ$ 7
.ZZ7 8
ObtenerResumenZZ8 F
(ZZF G
clienteZZG N
.ZZN O
	IdClienteZZO X
,ZZX Y
prestamoZZZ b
)ZZb c
;ZZc d
Console[[ 
.[[ 
	WriteLine[[ !
([[! "
resumen[[" )
.[[) *"
PagosClientePendientes[[* @
)[[@ A
;[[A B
Console\\ 
.\\ 
	WriteLine\\ !
(\\! "
resumen\\" )
.\\) *
PrestamosCliente\\* :
)\\: ;
;\\; <
return]] 
Ok]] 
(]] 
resumen]] !
)]]! "
;]]" #
}^^ 
return__ 
NotFound__ 
(__ 
)__ 
;__ 
}`` 	
publicbb 
asyncbb 
Taskbb 
<bb 
IActionResultbb '
>bb' (
Salirbb) .
(bb. /
)bb/ 0
{cc 	
vardd 
usuariodd 
=dd 
Userdd 
.dd 
Identitydd '
!dd' (
.dd( )
Namedd) -
;dd- .
awaitee 
_auditoriaServiceee #
.ee# $
RegistrarLogee$ 0
(ee0 1
usuarioee1 8
!ee8 9
,ee9 :
$stree; B
,eeB C
$streeD ^
)ee^ _
;ee_ `
awaitgg 
HttpContextgg 
.gg 
SignOutAsyncgg *
(gg* +(
CookieAuthenticationDefaultsgg+ G
.ggG H 
AuthenticationSchemeggH \
)gg\ ]
;gg] ^
Responsejj 
.jj 
Cookiesjj 
.jj 
Deletejj #
(jj# $
$strjj$ 2
)jj2 3
;jj3 4
Responsekk 
.kk 
Cookieskk 
.kk 
Deletekk #
(kk# $
$strkk$ 2
)kk2 3
;kk3 4
returnmm 
RedirectToActionmm #
(mm# $
$strmm$ +
,mm+ ,
$strmm- 4
)mm4 5
;mm5 6
}nn 	
}oo 
}pp ®4
gC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\CuentaController.cs
	namespace

 	
Prestamo


 
.

 
Web

 
.

 
Controllers

 "
{ 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
CuentaController !
:" #

Controller$ .
{ 
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 

CuentaData #
_cuentaData$ /
;/ 0
public 
CuentaController 
(  
ClienteData  +
clienteData, 7
,7 8

CuentaData9 C

cuentaDataD N
)N O
{ 	
_clienteData 
= 
clienteData &
;& '
_cuentaData 
= 

cuentaData $
;$ %
} 	
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
try 
{ 
var 
correo 
= 
User !
.! "
	FindFirst" +
(+ ,

ClaimTypes, 6
.6 7
Email7 <
)< =
?= >
.> ?
Value? D
;D E
Console 
. 
	WriteLine !
(! "
$"" $
$str$ 7
{7 8
correo8 >
}> ?
"? @
)@ A
;A B
if 
( 
string 
. 
IsNullOrEmpty (
(( )
correo) /
)/ 0
)0 1
{   
Console!! 
.!! 
	WriteLine!! %
(!!% &
$str!!& J
)!!J K
;!!K L
return"" 
RedirectToAction"" +
(""+ ,
$str"", 3
,""3 4
$str""5 >
)""> ?
;""? @
}## 
var%% 
cliente%% 
=%% 
await%% #
_clienteData%%$ 0
.%%0 1
ObtenerPorCorreo%%1 A
(%%A B
correo%%B H
)%%H I
;%%I J
if'' 
('' 
cliente'' 
=='' 
null'' #
)''# $
{(( 
Console)) 
.)) 
	WriteLine)) %
())% &
$"))& (
$str))( O
{))O P
correo))P V
}))V W
"))W X
)))X Y
;))Y Z
return** 
RedirectToAction** +
(**+ ,
$str**, 3
,**3 4
$str**5 >
)**> ?
;**? @
}++ 
Console-- 
.-- 
	WriteLine-- !
(--! "
$"--" $
$str--$ ?
{--? @
cliente--@ G
.--G H
	IdCliente--H Q
}--Q R
"--R S
)--S T
;--T U
ViewBag.. 
... 
	IdCliente.. !
=.." #
cliente..$ +
...+ ,
	IdCliente.., 5
;..5 6
return00 
View00 
(00 
)00 
;00 
}11 
catch22 
(22 
	Exception22 
ex22 
)22  
{33 
Console44 
.44 
	WriteLine44 !
(44! "
$"44" $
$str44$ +
{44+ ,
ex44, .
.44. /
Message44/ 6
}446 7
"447 8
)448 9
;449 :
return55 
RedirectToAction55 '
(55' (
$str55( /
,55/ 0
$str551 :
)55: ;
;55; <
}66 
}77 	
[99 	
HttpGet99	 
]99 
[:: 	
	Authorize::	 
(:: 
Roles:: 
=:: 
$str:: $
)::$ %
]::% &
public;; 
async;; 
Task;; 
<;; 
IActionResult;; '
>;;' (
ObtenerCuenta;;) 6
(;;6 7
int;;7 :
	idCliente;;; D
);;D E
{<< 	
if== 
(== 
!== 

ModelState== 
.== 
IsValid== #
)==# $
{>> 
return?? 

BadRequest?? !
(??! "

ModelState??" ,
)??, -
;??- .
}@@ 
ConsoleAA 
.AA 
	WriteLineAA 
(AA 
$"AA  
$strAA  C
{AAC D
	idClienteAAD M
}AAM N
"AAN O
)AAO P
;AAP Q
tryCC 
{DD 
varEE 
cuentaEE 
=EE 
awaitEE "
_cuentaDataEE# .
.EE. /
ObtenerCuentaEE/ <
(EE< =
	idClienteEE= F
)EEF G
;EEG H
ifFF 
(FF 
cuentaFF 
==FF 
nullFF "
)FF" #
{GG 
returnHH 
JsonHH 
(HH  
newHH  #
{HH$ %
successHH& -
=HH. /
falseHH0 5
,HH5 6
messageHH7 >
=HH? @
$strHHA [
}HH\ ]
)HH] ^
;HH^ _
}II 
ConsoleKK 
.KK 
	WriteLineKK !
(KK! "
$"KK" $
$strKK$ 7
{KK7 8
cuentaKK8 >
?KK> ?
.KK? @
TarjetaKK@ G
??KKH J
$strKKK Q
}KKQ R
"KKR S
)KKS T
;KKT U
returnLL 
JsonLL 
(LL 
newLL 
{LL  !
successLL" )
=LL* +
trueLL, 0
,LL0 1
dataLL2 6
=LL7 8
cuentaLL9 ?
}LL@ A
)LLA B
;LLB C
}MM 
catchNN 
(NN 
	ExceptionNN 
exNN 
)NN  
{OO 
ConsolePP 
.PP 
	WriteLinePP !
(PP! "
$"PP" $
$strPP$ =
{PP= >
exPP> @
.PP@ A
MessagePPA H
}PPH I
"PPI J
)PPJ K
;PPK L
returnQQ 
JsonQQ 
(QQ 
newQQ 
{QQ  !
successQQ" )
=QQ* +
falseQQ, 1
,QQ1 2
messageQQ3 :
=QQ; <
$strQQ= Y
}QQZ [
)QQ[ \
;QQ\ ]
}RR 
}SS 	
}UU 
}VV ™M
gC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\CobrarController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
CobrarController !
:" #

Controller$ .
{ 
private 
readonly 
PrestamoData %
_prestamoData& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
public 
CobrarController 
(  
PrestamoData  ,
prestamoData- 9
,9 :
AuditoriaService; K
auditoriaServiceL \
,\ ]
ClienteData^ i
clienteDataj u
)u v
{ 	
_prestamoData 
= 
prestamoData (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
_clienteData 
= 
clienteData &
;& '
} 	
public 
async 
Task 
< 
IActionResult '
>' (
Index) .
(. /
)/ 0
{ 	
try 
{ 
var 
correo 
= 
User !
.! "
	FindFirst" +
(+ ,

ClaimTypes, 6
.6 7
Email7 <
)< =
?= >
.> ?
Value? D
;D E
Console 
. 
	WriteLine !
(! "
$"" $
$str$ 7
{7 8
correo8 >
}> ?
"? @
)@ A
;A B
if   
(   
string   
.   
IsNullOrEmpty   (
(  ( )
correo  ) /
)  / 0
)  0 1
{!! 
Console"" 
."" 
	WriteLine"" %
(""% &
$str""& J
)""J K
;""K L
return## 
RedirectToAction## +
(##+ ,
$str##, 3
,##3 4
$str##5 >
)##> ?
;##? @
}$$ 
var&& 
cliente&& 
=&& 
await&& #
_clienteData&&$ 0
.&&0 1
ObtenerPorCorreo&&1 A
(&&A B
correo&&B H
)&&H I
;&&I J
if(( 
((( 
cliente(( 
==(( 
null(( #
)((# $
{)) 
Console** 
.** 
	WriteLine** %
(**% &
$"**& (
$str**( O
{**O P
correo**P V
}**V W
"**W X
)**X Y
;**Y Z
return++ 
RedirectToAction++ +
(+++ ,
$str++, 3
,++3 4
$str++5 >
)++> ?
;++? @
},, 
Console.. 
... 
	WriteLine.. !
(..! "
$".." $
$str..$ ?
{..? @
cliente..@ G
...G H
	IdCliente..H Q
}..Q R
"..R S
)..S T
;..T U
ViewBag// 
.// 
	IdCliente// !
=//" #
cliente//$ +
.//+ ,
	IdCliente//, 5
;//5 6
return11 
View11 
(11 
)11 
;11 
}22 
catch33 
(33 
	Exception33 
ex33 
)33  
{44 
Console55 
.55 
	WriteLine55 !
(55! "
$"55" $
$str55$ +
{55+ ,
ex55, .
.55. /
Message55/ 6
}556 7
"557 8
)558 9
;559 :
return66 
RedirectToAction66 '
(66' (
$str66( /
,66/ 0
$str661 :
)66: ;
;66; <
}77 
}88 	
[:: 	
HttpPost::	 
]:: 
[;; 	
	Authorize;;	 
(;; 
Roles;; 
=;; 
$str;; $
);;$ %
];;% &
public<< 
async<< 
Task<< 
<<< 
IActionResult<< '
><<' (
PagarCuotas<<) 4
(<<4 5
[<<5 6
FromBody<<6 >
]<<> ?
PagarCuotasRequest<<@ R
request<<S Z
)<<Z [
{== 	
if>> 
(>> 
!>> 

ModelState>> 
.>> 
IsValid>> #
)>># $
{?? 
return@@ 

BadRequest@@ !
(@@! "

ModelState@@" ,
)@@, -
;@@- .
}AA 
ifBB 
(BB 
requestBB 
==BB 
nullBB 
)BB  
{CC 
returnDD 

StatusCodeDD !
(DD! "
StatusCodesDD" -
.DD- .
Status400BadRequestDD. A
,DDA B
newDDC F
{DDG H
dataDDI M
=DDN O
$strDDP s
}DDt u
)DDu v
;DDv w
}EE 
ifGG 
(GG 
stringGG 
.GG 
IsNullOrEmptyGG $
(GG$ %
requestGG% ,
.GG, -
NumeroTarjetaGG- :
)GG: ;
)GG; <
{HH 
returnII 

StatusCodeII !
(II! "
StatusCodesII" -
.II- .
Status400BadRequestII. A
,IIA B
newIIC F
{IIG H
dataIII M
=IIN O
$strIIP s
}IIt u
)IIu v
;IIv w
}JJ 
ifLL 
(LL 
requestLL 
.LL 

IdPrestamoLL "
<=LL# %
$numLL& '
)LL' (
{MM 
returnNN 

StatusCodeNN !
(NN! "
StatusCodesNN" -
.NN- .
Status400BadRequestNN. A
,NNA B
newNNC F
{NNG H
dataNNI M
=NNN O
$strNNP q
}NNr s
)NNs t
;NNt u
}OO 
ifQQ 
(QQ 
stringQQ 
.QQ 
IsNullOrEmptyQQ $
(QQ$ %
requestQQ% ,
.QQ, -
NroCuotasPagadasQQ- =
)QQ= >
)QQ> ?
{RR 
returnSS 

StatusCodeSS !
(SS! "
StatusCodesSS" -
.SS- .
Status400BadRequestSS. A
,SSA B
newSSC F
{SSG H
dataSSI M
=SSN O
$strSSP u
}SSv w
)SSw x
;SSx y
}TT 
tryVV 
{WW 
stringXX 
	respuestaXX  
=XX! "
awaitXX# (
_prestamoDataXX) 6
.XX6 7
PagarCuotasXX7 B
(XXB C
requestYY 
.YY 

IdPrestamoYY &
,YY& '
requestZZ 
.ZZ 
NroCuotasPagadasZZ ,
,ZZ, -
request[[ 
.[[ 
NumeroTarjeta[[ )
)\\ 
;\\ 
if^^ 
(^^ 
	respuesta^^ 
.^^ 

StartsWith^^ (
(^^( )
$str^^) 0
)^^0 1
||^^2 4
	respuesta^^5 >
.^^> ?
Contains^^? G
(^^G H
$str^^H T
)^^T U
||^^V X
	respuesta^^Y b
.^^b c
Contains^^c k
(^^k l
$str^^l {
)^^{ |
)^^| }
{__ 
return`` 

StatusCode`` %
(``% &
StatusCodes``& 1
.``1 2
Status400BadRequest``2 E
,``E F
new``G J
{``K L
data``M Q
=``R S
	respuesta``T ]
}``^ _
)``_ `
;``` a
}aa 
awaitcc 
_auditoriaServicecc '
.cc' (
RegistrarLogcc( 4
(cc4 5
Usercc5 9
!cc9 :
.cc: ;
Identitycc; C
!ccC D
.ccD E
NameccE I
!ccI J
,ccJ K
$strccL S
,ccS T
$"ccU W
$strccW e
{cce f
requestccf m
.ccm n
NroCuotasPagadasccn ~
}cc~ 
"	cc Ä
)
ccÄ Å
;
ccÅ Ç
returndd 

StatusCodedd !
(dd! "
StatusCodesdd" -
.dd- .
Status200OKdd. 9
,dd9 :
newdd; >
{dd? @
dataddA E
=ddF G
	respuestaddH Q
}ddR S
)ddS T
;ddT U
}ee 
catchff 
(ff 
	Exceptionff 
exff 
)ff  
{gg 
returnhh 

StatusCodehh !
(hh! "
StatusCodeshh" -
.hh- .(
Status500InternalServerErrorhh. J
,hhJ K
newhhL O
{hhP Q
datahhR V
=hhW X
$strhhY v
+hhw x
exhhy {
.hh{ |
Message	hh| É
}
hhÑ Ö
)
hhÖ Ü
;
hhÜ á
}ii 
}jj 	
publicll 
classll 
PagarCuotasRequestll '
{mm 	
publicnn 
intnn 

IdPrestamonn !
{nn" #
getnn$ '
;nn' (
setnn) ,
;nn, -
}nn. /
publicoo 
stringoo 
NroCuotasPagadasoo *
{oo+ ,
getoo- 0
;oo0 1
setoo2 5
;oo5 6
}oo7 8
publicpp 
stringpp 
NumeroTarjetapp '
{pp( )
getpp* -
;pp- .
setpp/ 2
;pp2 3
}pp4 5
}qq 	
}rr 
}ss ÷d
hC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\ClienteController.cs
	namespace		 	
Prestamo		
 
.		 
Web		 
.		 
Controllers		 "
{

 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
ClienteController "
:# $

Controller% /
{ 
private 
readonly 
ClienteData $
_clienteData% 1
;1 2
private 
readonly 

CuentaData #
_cuentaData$ /
;/ 0
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
ClienteController  
(  !
ClienteData! ,
clienteData- 8
,8 9

CuentaData: D

cuentaDataE O
,O P
AuditoriaServiceQ a
auditoriaServiceb r
)r s
{ 	
_clienteData 
= 
clienteData &
;& '
_cuentaData 
= 

cuentaData $
;$ %
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
public 
IActionResult 
Index "
(" #
)# $
{ 	
return 
View 
( 
) 
; 
} 	
[ 	
HttpGet	 
] 
[ 	
	Authorize	 
( 
Roles 
= 
$str *
)* +
]+ ,
public   
async   
Task   
<   
IActionResult   '
>  ' (
Lista  ) .
(  . /
)  / 0
{!! 	
List"" 
<"" 
Cliente"" 
>"" 
lista"" 
=""  !
await""" '
_clienteData""( 4
.""4 5
Lista""5 :
("": ;
)""; <
;""< =
await## 
_auditoriaService## #
.### $
RegistrarLog##$ 0
(##0 1
User##1 5
.##5 6
Identity##6 >
.##> ?
Name##? C
,##C D
$str##E L
,##L M
$str##N y
)##y z
;##z {
return$$ 

StatusCode$$ 
($$ 
StatusCodes$$ )
.$$) *
Status200OK$$* 5
,$$5 6
new$$7 :
{$$; <
data$$= A
=$$B C
lista$$D I
}$$J K
)$$K L
;$$L M
}%% 	
['' 	
HttpPost''	 
]'' 
[(( 	
	Authorize((	 
((( 
Roles(( 
=(( 
$str(( *
)((* +
]((+ ,
public)) 
async)) 
Task)) 
<)) 
IActionResult)) '
>))' (
Crear))) .
()). /
[))/ 0
FromBody))0 8
]))8 9
Cliente)): A
objeto))B H
)))H I
{** 	
if++ 
(++ 
!++ 

ModelState++ 
.++ 
IsValid++ #
)++# $
{,, 
return-- 

BadRequest-- !
(--! "

ModelState--" ,
)--, -
;--- .
}.. 
string// 
	respuesta// 
=// 
await// $
_clienteData//% 1
.//1 2
Crear//2 7
(//7 8
objeto//8 >
)//> ?
;//? @
await00 
_auditoriaService00 #
.00# $
RegistrarLog00$ 0
(000 1
User001 5
.005 6
Identity006 >
.00> ?
Name00? C
,00C D
$str00E L
,00L M
$"00N P
$str00P `
{00` a
objeto00a g
.00g h
Nombre00h n
}00n o
$str00o p
{00p q
objeto00q w
.00w x
Apellido	00x Ä
}
00Ä Å
"
00Å Ç
)
00Ç É
;
00É Ñ
return11 

StatusCode11 
(11 
StatusCodes11 )
.11) *
Status200OK11* 5
,115 6
new117 :
{11; <
data11= A
=11B C
	respuesta11D M
}11N O
)11O P
;11P Q
}22 	
[44 	
HttpPut44	 
]44 
[55 	
	Authorize55	 
(55 
Roles55 
=55 
$str55 *
)55* +
]55+ ,
public66 
async66 
Task66 
<66 
IActionResult66 '
>66' (
Editar66) /
(66/ 0
[660 1
FromBody661 9
]669 :
Cliente66; B
objeto66C I
)66I J
{77 	
if88 
(88 
!88 

ModelState88 
.88 
IsValid88 #
)88# $
{99 
return:: 

BadRequest:: !
(::! "

ModelState::" ,
)::, -
;::- .
};; 
string<< 
	respuesta<< 
=<< 
await<< $
_clienteData<<% 1
.<<1 2
Editar<<2 8
(<<8 9
objeto<<9 ?
)<<? @
;<<@ A
await== 
_auditoriaService== #
.==# $
RegistrarLog==$ 0
(==0 1
User==1 5
.==5 6
Identity==6 >
.==> ?
Name==? C
,==C D
$str==E M
,==M N
$"==O Q
$str==Q b
{==b c
objeto==c i
.==i j
Nombre==j p
}==p q
$str==q r
{==r s
objeto==s y
.==y z
Apellido	==z Ç
}
==Ç É
"
==É Ñ
)
==Ñ Ö
;
==Ö Ü
return>> 

StatusCode>> 
(>> 
StatusCodes>> )
.>>) *
Status200OK>>* 5
,>>5 6
new>>7 :
{>>; <
data>>= A
=>>B C
	respuesta>>D M
}>>N O
)>>O P
;>>P Q
}?? 	
[AA 	

HttpDeleteAA	 
]AA 
[BB 	
	AuthorizeBB	 
(BB 
RolesBB 
=BB 
$strBB *
)BB* +
]BB+ ,
publicCC 
asyncCC 
TaskCC 
<CC 
IActionResultCC '
>CC' (
EliminarCC) 1
(CC1 2
intCC2 5
IdCC6 8
)CC8 9
{DD 	
ifEE 
(EE 
!EE 

ModelStateEE 
.EE 
IsValidEE #
)EE# $
{FF 
returnGG 

BadRequestGG !
(GG! "

ModelStateGG" ,
)GG, -
;GG- .
}HH 
stringII 
	respuestaII 
=II 
awaitII $
_clienteDataII% 1
.II1 2
EliminarII2 :
(II: ;
IdII; =
)II= >
;II> ?
awaitJJ 
_auditoriaServiceJJ #
.JJ# $
RegistrarLogJJ$ 0
(JJ0 1
UserJJ1 5
.JJ5 6
IdentityJJ6 >
.JJ> ?
NameJJ? C
,JJC D
$strJJE O
,JJO P
$"JJQ S
$strJJS m
{JJm n
IdJJn p
}JJp q
"JJq r
)JJr s
;JJs t
returnKK 

StatusCodeKK 
(KK 
StatusCodesKK )
.KK) *
Status200OKKK* 5
,KK5 6
newKK7 :
{KK; <
dataKK= A
=KKB C
	respuestaKKD M
}KKN O
)KKO P
;KKP Q
}LL 	
[NN 	
	AuthorizeNN	 
(NN 
RolesNN 
=NN 
$strNN $
)NN$ %
]NN% &
publicOO 
asyncOO 
TaskOO 
<OO 
IActionResultOO '
>OO' (
CuentaOO) /
(OO/ 0
)OO0 1
{PP 	
varQQ 
correoQQ 
=QQ 
UserQQ 
.QQ 
	FindFirstQQ '
(QQ' (

ClaimTypesQQ( 2
.QQ2 3
EmailQQ3 8
)QQ8 9
?QQ9 :
.QQ: ;
ValueQQ; @
;QQ@ A
ConsoleRR 
.RR 
	WriteLineRR 
(RR 
correoRR $
)RR$ %
;RR% &
ifSS 
(SS 
stringSS 
.SS 
IsNullOrEmptySS $
(SS$ %
correoSS% +
)SS+ ,
)SS, -
{TT 
returnUU 
RedirectToActionUU '
(UU' (
$strUU( /
,UU/ 0
$strUU1 7
)UU7 8
;UU8 9
}VV 
varXX 
clienteXX 
=XX 
awaitXX 
_clienteDataXX  ,
.XX, -
ObtenerPorCorreoXX- =
(XX= >
correoXX> D
)XXD E
;XXE F
ifYY 
(YY 
clienteYY 
==YY 
nullYY 
)YY  
{ZZ 
return[[ 
RedirectToAction[[ '
([[' (
$str[[( /
,[[/ 0
$str[[1 7
)[[7 8
;[[8 9
}\\ 
return^^ 
RedirectToAction^^ #
(^^# $
$str^^$ +
,^^+ ,
$str^^- 5
,^^5 6
new^^7 :
{^^; <
	idCliente^^= F
=^^G H
cliente^^I P
.^^P Q
	IdCliente^^Q Z
}^^[ \
)^^\ ]
;^^] ^
}__ 	
[bb 	
HttpPostbb	 
]bb 
[cc 	
	Authorizecc	 
(cc 
Rolescc 
=cc 
$strcc $
)cc$ %
]cc% &
publicdd 
asyncdd 
Taskdd 
<dd 
IActionResultdd '
>dd' (
	Depositardd) 2
(dd2 3
[dd3 4
FromBodydd4 <
]dd< =
DepositoRequestdd> M
requestddN U
)ddU V
{ee 	
ifff 
(ff 
!ff 

ModelStateff 
.ff 
IsValidff #
)ff# $
{gg 
returnhh 

BadRequesthh !
(hh! "

ModelStatehh" ,
)hh, -
;hh- .
}ii 
tryjj 
{kk 
varll 
	resultadoll 
=ll 
awaitll  %
_cuentaDatall& 1
.ll1 2
	Depositarll2 ;
(ll; <
requestll< C
.llC D
	IdClientellD M
,llM N
requestllO V
.llV W
MontollW \
)ll\ ]
;ll] ^
ifmm 
(mm 
stringmm 
.mm 
IsNullOrEmptymm (
(mm( )
	resultadomm) 2
)mm2 3
)mm3 4
{nn 
awaitoo 
_auditoriaServiceoo +
.oo+ ,
RegistrarLogoo, 8
(oo8 9
Useroo9 =
.oo= >
Identityoo> F
.ooF G
NameooG K
,ooK L
$strooM X
,ooX Y
$"ooZ \
$stroo\ h
{ooh i
requestooi p
.oop q
Montoooq v
}oov w
$str	oow ü
{
ooü †
request
oo† ß
.
ooß ®
	IdCliente
oo® ±
}
oo± ≤
"
oo≤ ≥
)
oo≥ ¥
;
oo¥ µ
returnpp 
Jsonpp 
(pp  
newpp  #
{pp$ %
successpp& -
=pp. /
truepp0 4
}pp5 6
)pp6 7
;pp7 8
}qq 
elserr 
{ss 
returntt 
Jsontt 
(tt  
newtt  #
{tt$ %
successtt& -
=tt. /
falsett0 5
,tt5 6
errortt7 <
=tt= >
	resultadott? H
}ttI J
)ttJ K
;ttK L
}uu 
}vv 
catchww 
(ww 
	Exceptionww 
exww 
)ww  
{xx 
returnyy 

StatusCodeyy !
(yy! "
$numyy" %
,yy% &
newyy' *
{yy+ ,
successyy- 4
=yy5 6
falseyy7 <
,yy< =
erroryy> C
=yyD E
exyyF H
.yyH I
MessageyyI P
}yyQ R
)yyR S
;yyS T
}zz 
}{{ 	
}|| 
public~~ 

class~~ 
DepositoRequest~~  
{ 
public
ÄÄ 
int
ÄÄ 
	IdCliente
ÄÄ 
{
ÄÄ 
get
ÄÄ "
;
ÄÄ" #
set
ÄÄ$ '
;
ÄÄ' (
}
ÄÄ) *
public
ÅÅ 
decimal
ÅÅ 
Monto
ÅÅ 
{
ÅÅ 
get
ÅÅ "
;
ÅÅ" #
set
ÅÅ$ '
;
ÅÅ' (
}
ÅÅ) *
}
ÇÇ 
}ÉÉ ¯O
hC:\Users\USUARIO\Desktop\DesarrolloSeguro2\SistemaPrestamo\Prestamo.Web\Controllers\AccountController.cs
	namespace 	
Prestamo
 
. 
Web 
. 
Controllers "
{ 
[ 
	Authorize 
( !
AuthenticationSchemes $
=% &
JwtBearerDefaults' 8
.8 9 
AuthenticationScheme9 M
)M N
]N O
public 

class 
AccountController "
:# $

Controller% /
{ 
private 
readonly 
UsuarioData $
_usuarioData% 1
;1 2
private 
readonly 
EmailService %
_emailService& 3
;3 4
private 
readonly 
AuditoriaService )
_auditoriaService* ;
;; <
public 
AccountController  
(  !
UsuarioData! ,
usuarioData- 8
,8 9
EmailService: F
emailServiceG S
,S T
AuditoriaServiceU e
auditoriaServicef v
)v w
{ 	
_usuarioData 
= 
usuarioData &
;& '
_emailService 
= 
emailService (
;( )
_auditoriaService 
= 
auditoriaService  0
;0 1
} 	
[ 	
HttpGet	 
] 
public 
IActionResult 
ChangePassword +
(+ ,
), -
{ 	
return 
View 
( 
) 
; 
} 	
[!! 	
HttpPost!!	 
]!! 
public"" 
async"" 
Task"" 
<"" 
IActionResult"" '
>""' ('
SolicitarCodigoVerificacion"") D
(""D E
[""E F
FromBody""F N
]""N O#
ChangePasswordViewModel""P g
model""h m
)""m n
{## 	
if$$ 
($$ 
!$$ 

ModelState$$ 
.$$ 
IsValid$$ #
)$$# $
{%% 
return&& 

BadRequest&& !
(&&! "

ModelState&&" ,
)&&, -
;&&- .
}'' 
var)) 
userId)) 
=)) 
User)) 
.)) 
	FindFirst)) '
())' (

ClaimTypes))( 2
.))2 3
NameIdentifier))3 A
)))A B
?))B C
.))C D
Value))D I
;))I J
if** 
(** 
userId** 
==** 
null** 
)** 
{++ 
return,, 
Json,, 
(,, 
new,, 
{,,  !
success,," )
=,,* +
false,,, 1
,,,1 2
message,,3 :
=,,; <
$str,,= U
},,V W
),,W X
;,,X Y
}-- 
var// 
usuario// 
=// 
await// 
_usuarioData//  ,
.//, -
ObtenerPorId//- 9
(//9 :
int//: =
.//= >
Parse//> C
(//C D
userId//D J
)//J K
)//K L
;//L M
if00 
(00 
usuario00 
==00 
null00 
)00  
{11 
return22 
Json22 
(22 
new22 
{22  !
success22" )
=22* +
false22, 1
,221 2
message223 :
=22; <
$str22= T
}22U V
)22V W
;22W X
}33 
bool55 
isPasswordValid55  
=55! "
BCrypt55# )
.55) *
Net55* -
.55- .
BCrypt55. 4
.554 5
Verify555 ;
(55; <
model55< A
.55A B
CurrentPassword55B Q
,55Q R
usuario55S Z
.55Z [
Clave55[ `
)55` a
;55a b
if66 
(66 
!66 
isPasswordValid66  
)66  !
{77 
return88 
Json88 
(88 
new88 
{88  !
success88" )
=88* +
false88, 1
,881 2
message883 :
=88; <
$str88= a
}88b c
)88c d
;88d e
}99 
var<< 
codigoVerificacion<< "
=<<# $%
GenerarCodigoVerificacion<<% >
(<<> ?
)<<? @
;<<@ A
HttpContext== 
.== 
Session== 
.==  
	SetString==  )
(==) *
$str==* >
,==> ?
codigoVerificacion==@ R
)==R S
;==S T
string@@ 
asunto@@ 
=@@ 
$str@@ N
;@@N O
stringAA 
mensajeAA 
=AA 
$"AA 
$strAA =
{AA= >
codigoVerificacionAA> P
}AAP Q
"AAQ R
;AAR S
awaitBB 
_emailServiceBB 
.BB  
EnviarCorreoAsyncBB  1
(BB1 2
usuarioBB2 9
.BB9 :
CorreoBB: @
,BB@ A
asuntoBBB H
,BBH I
mensajeBBJ Q
)BBQ R
;BBR S
returnCC 
JsonCC 
(CC 
newCC 
{CC 
successCC %
=CC& '
trueCC( ,
}CC- .
)CC. /
;CC/ 0
}DD 	
[FF 	
HttpPostFF	 
]FF 
[GG 	
	AuthorizeGG	 
(GG 
RolesGG 
=GG 
$strGG $
)GG$ %
]GG% &
publicHH 
asyncHH 
TaskHH 
<HH 
IActionResultHH '
>HH' (
ChangePasswordHH) 7
(HH7 8
[HH8 9
FromBodyHH9 A
]HHA B#
ChangePasswordViewModelHHC Z
modelHH[ `
)HH` a
{II 	
ifJJ 
(JJ 
!JJ 

ModelStateJJ 
.JJ 
IsValidJJ #
)JJ# $
{KK 
returnLL 

BadRequestLL !
(LL! "

ModelStateLL" ,
)LL, -
;LL- .
}MM 
varOO 
userIdOO 
=OO 
UserOO 
.OO 
	FindFirstOO '
(OO' (

ClaimTypesOO( 2
.OO2 3
NameIdentifierOO3 A
)OOA B
?OOB C
.OOC D
ValueOOD I
;OOI J
ifPP 
(PP 
userIdPP 
==PP 
nullPP 
)PP 
{QQ 
returnRR 
JsonRR 
(RR 
newRR 
{RR  !
successRR" )
=RR* +
falseRR, 1
,RR1 2
messageRR3 :
=RR; <
$strRR= U
}RRV W
)RRW X
;RRX Y
}SS 
varUU 
usuarioUU 
=UU 
awaitUU 
_usuarioDataUU  ,
.UU, -
ObtenerPorIdUU- 9
(UU9 :
intUU: =
.UU= >
ParseUU> C
(UUC D
userIdUUD J
)UUJ K
)UUK L
;UUL M
ifVV 
(VV 
usuarioVV 
==VV 
nullVV 
)VV  
{WW 
returnXX 
JsonXX 
(XX 
newXX 
{XX  !
successXX" )
=XX* +
falseXX, 1
,XX1 2
messageXX3 :
=XX; <
$strXX= T
}XXU V
)XXV W
;XXW X
}YY 
var[[ 
codigoVerificacion[[ "
=[[# $
HttpContext[[% 0
.[[0 1
Session[[1 8
.[[8 9
	GetString[[9 B
([[B C
$str[[C W
)[[W X
;[[X Y
if\\ 
(\\ 
model\\ 
.\\ 
VerificationCode\\ &
!=\\' )
codigoVerificacion\\* <
)\\< =
{]] 
return^^ 
Json^^ 
(^^ 
new^^ 
{^^  !
success^^" )
=^^* +
false^^, 1
,^^1 2
message^^3 :
=^^; <
$str^^= f
}^^g h
)^^h i
;^^i j
}__ 
usuarioaa 
.aa 
Claveaa 
=aa 
BCryptaa "
.aa" #
Netaa# &
.aa& '
BCryptaa' -
.aa- .
HashPasswordaa. :
(aa: ;
modelaa; @
.aa@ A
NewPasswordaaA L
)aaL M
;aaM N
awaitbb 
_usuarioDatabb 
.bb 

Actualizarbb )
(bb) *
usuariobb* 1
)bb1 2
;bb2 3
awaitcc 
_auditoriaServicecc #
.cc# $
RegistrarLogcc$ 0
(cc0 1
Usercc1 5
.cc5 6
Identitycc6 >
.cc> ?
Namecc? C
,ccC D
$strccE M
,ccM N
$"ccO Q
$strccQ e
{cce f
usuarioccf m
.ccm n
Claveccn s
}ccs t
"cct u
)ccu v
;ccv w
returndd 
Jsondd 
(dd 
newdd 
{dd 
successdd %
=dd& '
truedd( ,
}dd- .
)dd. /
;dd/ 0
}ee 	
privategg 
stringgg %
GenerarCodigoVerificaciongg 0
(gg0 1
)gg1 2
{hh 	
usingii 
(ii 
varii 
rngii 
=ii !
RandomNumberGeneratorii 2
.ii2 3
Createii3 9
(ii9 :
)ii: ;
)ii; <
{jj 
varkk 
byteskk 
=kk 
newkk 
bytekk  $
[kk$ %
$numkk% &
]kk& '
;kk' (
rngll 
.ll 
GetBytesll 
(ll 
bytesll "
)ll" #
;ll# $
returnmm 
BitConvertermm #
.mm# $
ToUInt32mm$ ,
(mm, -
bytesmm- 2
,mm2 3
$nummm4 5
)mm5 6
.mm6 7
ToStringmm7 ?
(mm? @
$strmm@ D
)mmD E
;mmE F
}nn 
}oo 	
}pp 
}qq 